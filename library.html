<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library â€¢ Study Companion</title>

  <!-- Favicon (stops 404s) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Ctext y='1em' font-size='96'%3EðŸ“š%3C/text%3E%3C/svg%3E" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <!-- localForage before storage.js uses it -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

  <style>
    body{
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(13,110,253,.06), transparent),
        radial-gradient(1000px 500px at 110% 120%, rgba(102,16,242,.06), transparent);
      background-color: var(--bs-body-bg);
    }

    .toolbar{
      gap:.5rem; flex-wrap:wrap
    }
    .toolbar .form-control, .toolbar .form-select{
      min-width: 220px;
    }

    .dropzone{
      display:none;
      border:2px dashed #cfe2ff;
      border-radius:12px;
      padding:1rem;
      text-align:center;
      color:#0a58ca;
      background: #f8fbff;
      margin-bottom: 1rem;
    }
    .dropzone.active{
      display:block;
      border-color:#0d6efd;
      background:#eef4ff;
    }

    .card-row{
      border:1px solid #e9ecef; border-radius:12px; padding:.75rem; margin-bottom:.6rem; background:#fff;
    }
    .card-row .meta{ font-size:.825rem; color:#6c757d }
    .section-title{ font-weight:700; margin:.75rem 0 .5rem; color:#0d6efd }
    .empty{ color:#6c757d }
    .badge-type{ letter-spacing:.3px; }

    /* Dark mode polish */
    [data-bs-theme="dark"] .card-row{ background:#171717; border-color:rgba(255,255,255,.12) }
    [data-bs-theme="dark"] .meta, [data-bs-theme="dark"] .empty{ color:rgba(255,255,255,.7) }
    [data-bs-theme="dark"] .section-title{ color:#91b7ff }
    [data-bs-theme="dark"] .dropzone{ border-color:#294b86; background:#101827; color:#cfe2ff }

    .pill{ padding:.15rem .5rem; border-radius:999px; border:1px solid rgba(13,110,253,.25); }
    [data-bs-theme="dark"] .pill{ border-color:rgba(255,255,255,.2) }
  </style>
</head>
<body>
  <nav class="navbar bg-light border-bottom">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="app.html" title="Back"><i class="fa-solid fa-arrow-left"></i></a>
        <strong>Library</strong>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-primary" id="btn-import"><i class="fa-solid fa-upload me-1"></i>Import</button>
      </div>
    </div>
  </nav>

  <main class="container my-3">
    <!-- Toolbar -->
    <div class="d-flex toolbar mb-3">
      <input id="q" class="form-control" placeholder="Search by title or typeâ€¦"/>
      <select id="sort" class="form-select" aria-label="Sort">
        <option value="recent" selected>Sort: Recent</option>
        <option value="title">Sort: Title (Aâ†’Z)</option>
        <option value="type">Sort: Type</option>
      </select>
      <span class="pill small text-muted ms-auto" id="stats">â€”</span>
    </div>

    <!-- Drag & drop zone (appears only when dragging files) -->
    <div id="dropzone" class="dropzone">
      <i class="fa-solid fa-cloud-arrow-up me-1"></i> Drop files to import (EPUB, PDF, DOCX, TXT, MD)
    </div>

    <div id="lib-favorites"></div>
    <div id="lib-recent"></div>
    <div id="lib-all"></div>
    <hr>
    <div id="lib-trash"></div>
  </main>

  <!-- Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body">Done</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { storage } from './js/storage.js';
    import { reader } from './js/reader.js'; // for import helpers

    // --- toast helper ---
    const toast = (msg, type='primary') => {
      const el = document.getElementById('toast');
      const body = document.getElementById('toast-body');
      body.textContent = msg;
      el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, { autohide: true, delay: 1800 }).show();
    };

    // --- DOM refs ---
    const boxFav = document.getElementById('lib-favorites');
    const boxRec = document.getElementById('lib-recent');
    const boxAll = document.getElementById('lib-all');
    const boxTrash = document.getElementById('lib-trash');
    const q = document.getElementById('q');
    const sortSel = document.getElementById('sort');
    const stats = document.getElementById('stats');
    const dropzone = document.getElementById('dropzone');

    // --- state ---
    let allDocs = [];
    let favIds = [];
    let trashed = [];
    let active = [];
    let searchTerm = '';
    let sortKey = 'recent';

    // --- render helpers ---
    const itemRow = (d, opts={trashed:false, isFav:false}) => `
      <div class="card-row d-flex justify-content-between align-items-center shadow-sm">
        <div class="me-2">
          <div class="fw-semibold">${escapeHtml(d.title || '(Untitled)')}</div>
          <div class="meta">
            <span class="badge text-bg-light badge-type">${(d.type || '').toUpperCase()}</span>
            Â· ${new Date(d.updatedAt || d.createdAt || Date.now()).toLocaleString()}
          </div>
        </div>
        <div class="btn-group btn-group-sm">
          ${
            opts.trashed
            ? `
              <button class="btn btn-outline-secondary" data-restore="${d.id}" title="Restore"><i class="fa-solid fa-rotate-left"></i></button>
              <button class="btn btn-outline-danger" data-harddel="${d.id}" title="Delete forever"><i class="fa-solid fa-trash"></i></button>
            `
            : `
              <button class="btn btn-outline-primary" data-open="${d.id}" title="Open"><i class="fa-solid fa-folder-open"></i></button>
              <button class="btn btn-outline-warning" data-fav="${d.id}" title="${opts.isFav?'Unfavorite':'Favorite'}">
                <i class="fa${opts.isFav?'s':'-regular'} fa-star"></i>
              </button>
              <button class="btn btn-outline-danger" data-softdel="${d.id}" title="Move to Trash"><i class="fa-solid fa-trash"></i></button>
            `
          }
        </div>
      </div>`;

    const section = (title, listHtml, emptyText) => `
      <div class="section">
        <div class="section-title">${title}</div>
        ${listHtml || `<div class="empty">${emptyText}</div>`}
      </div>`;

    function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; }

    // --- actions (with fallbacks for older storage builds) ---
    async function hardDeleteDoc(id){
      if (!confirm('Permanently delete this item? This cannot be undone.')) return;
      try {
        if (typeof storage.hardDeleteDocument === 'function') {
          await storage.hardDeleteDocument(id);
        } else {
          await storage.deleteDocument?.(id);
        }
        toast('Deleted permanently', 'danger');
        await refresh();
      } catch (e) { console.error(e); toast('Delete failed', 'danger'); }
    }
    async function softDeleteDoc(id){
      if (!confirm('Move this item to Trash?')) return;
      try {
        if (typeof storage.softDeleteDocument === 'function') {
          await storage.softDeleteDocument(id);
        } else {
          // fallback: emulate soft delete
          const docs = await storage.getDocuments();
          const idx = docs.findIndex(d=>d.id===id);
          if (idx !== -1) { docs[idx].deletedAt = new Date().toISOString(); await storage.setItem?.('documents', docs); }
        }
        toast('Moved to Trash', 'secondary');
        await refresh();
      } catch (e) { console.error(e); toast('Failed to move to Trash', 'danger'); }
    }
    async function restoreDoc(id){
      try {
        if (typeof storage.restoreDocument === 'function') {
          await storage.restoreDocument(id);
        } else {
          const docs = await storage.getDocuments();
          const idx = docs.findIndex(d=>d.id===id);
          if (idx !== -1) { delete docs[idx].deletedAt; await storage.setItem?.('documents', docs); }
        }
        toast('Restored', 'primary');
        await refresh();
      } catch (e) { console.error(e); toast('Restore failed', 'danger'); }
    }
    async function toggleFav(id){
      try {
        if (typeof storage.toggleFavorite === 'function') {
          await storage.toggleFavorite(id);
        } else {
          const key = 'favorites';
          const cur = (await storage.getItem?.(key)) || [];
          const next = cur.includes(id) ? cur.filter(x=>x!==id) : [...cur, id];
          await storage.setItem?.(key, next);
        }
        await refresh();
      } catch (e) { console.error(e); toast('Failed to toggle favorite', 'danger'); }
    }
    function openDoc(id){
      location.href = 'reader.html?doc=' + encodeURIComponent(id);
    }

    // --- import button ---
    document.getElementById('btn-import').addEventListener('click', async () => {
      try {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.epub,.pdf,.docx,.txt,.md';
        input.multiple = true;
        input.onchange = async () => {
          const files = Array.from(input.files || []);
          if (!files.length) return;
          let ok = 0;
          for (const f of files) {
            try{
              // Prefer storage.importFile if available (keeps your existing flow)
              const doc = await (storage.importFile ? storage.importFile(f) : reader.importPdf(f));
              if (doc?.id) ok++;
            }catch(e){ console.warn('import error', e); }
          }
          toast(ok ? `Imported ${ok} file(s)` : 'Import failed', ok ? 'success' : 'danger');
          await refresh();
        };
        input.click();
      } catch (e) { console.error(e); toast('Import failed', 'danger'); }
    });

    // --- drag & drop importing ---
    let dragCount = 0;
    ['dragenter','dragover'].forEach(ev =>
      document.addEventListener(ev, (e)=>{
        if (!e.dataTransfer?.types?.includes('Files')) return;
        e.preventDefault(); e.stopPropagation();
        dragCount++; dropzone.classList.add('active');
      }, false)
    );
    ['dragleave','drop'].forEach(ev =>
      document.addEventListener(ev, (e)=>{
        if (!e.dataTransfer?.types?.includes('Files')) return;
        e.preventDefault(); e.stopPropagation();
        dragCount = Math.max(0, dragCount-1);
        if (dragCount===0) dropzone.classList.remove('active');
      }, false)
    );
    document.addEventListener('drop', async (e)=>{
      const files = Array.from(e.dataTransfer?.files || []);
      if (!files.length) return;
      let ok = 0;
      for (const f of files) {
        try{
          const doc = await (storage.importFile ? storage.importFile(f) : null);
          if (doc?.id) ok++;
        }catch(err){ console.warn('drop import error', err); }
      }
      toast(ok ? ('Imported ' + ok + ' file(s)') : 'Import failed', ok ? 'success' : 'danger');
      await refresh();
    }, false);

    // --- main render ---
    function applySearchAndSort(list){
      let out = list;
      if (searchTerm) {
        const t = searchTerm.toLowerCase();
        out = out.filter(d =>
          (d.title||'').toLowerCase().includes(t) ||
          (d.type||'').toLowerCase().includes(t)
        );
      }
      if (sortKey === 'title') {
        out = out.slice().sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      } else if (sortKey === 'type') {
        out = out.slice().sort((a,b)=> (a.type||'').localeCompare(b.type||'') || (a.title||'').localeCompare(b.title||''));
      } else {
        // recent
        out = out.slice().sort((a,b)=>{
          const ta = new Date(a.lastOpened || a.updatedAt || a.createdAt || 0).getTime();
          const tb = new Date(b.lastOpened || b.updatedAt || b.createdAt || 0).getTime();
          return tb - ta;
        });
      }
      return out;
    }

    function render(){
      const favDocs = active.filter(d => favIds.includes(d.id));
      const recent   = applySearchAndSort(active).slice(0, 10);
      const all      = applySearchAndSort(active);
      const tr       = applySearchAndSort(trashed);

      stats.textContent = `${all.length} items (${favDocs.length} favorites, ${trashed.length} in trash)`;

      boxFav.innerHTML = section('Favorites',
        favDocs.map(d => itemRow(d, { isFav:true, trashed:false })).join(''),
        'No favorites yet.'
      );

      boxRec.innerHTML = section('Recent',
        recent.map(d => itemRow(d, { isFav: favIds.includes(d.id), trashed:false })).join(''),
        'Nothing recent.'
      );

      boxAll.innerHTML = section('All',
        all.map(d => itemRow(d, { isFav: favIds.includes(d.id), trashed:false })).join(''),
        'Your library is empty. Click Import to add files.'
      );

      boxTrash.innerHTML = section('Trash',
        tr.map(d => itemRow(d, { trashed:true })).join(''),
        'Trash is empty.'
      );

      delegateClicks();
    }

    function delegateClicks(){
      // open
      document.querySelectorAll('[data-open]').forEach(b => b.onclick = () => openDoc(b.getAttribute('data-open')));
      // fav
      document.querySelectorAll('[data-fav]').forEach(b => b.onclick = () => toggleFav(b.getAttribute('data-fav')));
      // soft delete
      document.querySelectorAll('[data-softdel]').forEach(b => b.onclick = () => softDeleteDoc(b.getAttribute('data-softdel')));
      // hard delete
      document.querySelectorAll('[data-harddel]').forEach(b => b.onclick = () => hardDeleteDoc(b.getAttribute('data-harddel')));
      // restore
      document.querySelectorAll('[data-restore]').forEach(b => b.onclick = () => restoreDoc(b.getAttribute('data-restore')));
    }

    async function refresh(){
      // (Re)load data then render with current filters/sort
      await storage.init?.();
      allDocs = await storage.getDocuments() || [];
      favIds = (await storage.getFavorites?.()) || [];
      active = allDocs.filter(d => !d.deletedAt);
      trashed = allDocs.filter(d => !!d.deletedAt);
      render();
    }

    // live search/sort
    q.addEventListener('input', ()=>{ searchTerm = (q.value||'').trim(); render(); });
    sortSel.addEventListener('change', ()=>{ sortKey = sortSel.value; render(); });

    // boot
    document.addEventListener('DOMContentLoaded', refresh);
  </script>
</body>
</html>
