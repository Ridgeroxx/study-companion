<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Notes — Study Companion</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#136FF2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="logo.png">

  <meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    img-src 'self' data: blob:;
    font-src 'self' data: https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    style-src-elem 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
    connect-src 'self' blob:;
    worker-src 'self' blob: https://cdnjs.cloudflare.com;
    object-src 'none';
    base-uri 'self';
    upgrade-insecure-requests;
  ">


  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/dark.css">

  <style>
    .note-card{border:1px solid #e9ecef; border-radius:10px; padding:.75rem; margin-bottom:.75rem; background:var(--bs-body-bg);}
    .tag{display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:var(--bs-secondary-bg); margin-right:.25rem; font-size:.75rem;}
    .note-actions .btn{ --bs-btn-padding-y:.2rem; --bs-btn-padding-x:.5rem; }
    .truncate-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>
<body>
  <nav class="navbar bg-light border-bottom sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="app.html" title="Back">
          <i class="fa-solid fa-arrow-left"></i>
        </a>
        <span class="fw-semibold">All Notes</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="lang-en">EN</button>
        <button class="btn btn-sm btn-outline-secondary" id="lang-es">ES</button>
        <button class="btn btn-sm btn-outline-secondary" id="theme-toggle" title="Theme">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <div class="notes-filters-sticky p-2 rounded border bg-body">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-6">
          <label class="form-label mb-1">Search</label>
          <div class="mt-2 d-flex flex-wrap gap-2">
  <button class="btn btn-sm btn-outline-primary" id="save-smart">
    <i class="fa-solid fa-folder-plus me-1"></i>Save Smart Folder
  </button>
</div>
          <div class="input-group input-group-sm">
            <input id="q" class="form-control" placeholder="Search notes, quotes, tags…">
            <button class="btn btn-outline-secondary" id="clear-q"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="form-text">Full-text search (Lunr if available, else substring).</div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label mb-1">Document</label>
              <select id="doc-filter" class="form-select form-select-sm"><option value="">All documents</option></select>
            </div>
            <div class="col-6">
              <label class="form-label mb-1">Sort</label>
              <select id="sort" class="form-select form-select-sm">
                <option value="newest">Newest first</option>
                <option value="oldest">Oldest first</option>
              </select>
            </div>
          </div>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="only-tagged">
              <label class="form-check-label small" for="only-tagged">Only notes with tags</label>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="save-search"><i class="fa-regular fa-bookmark me-1"></i>Save current search</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-12 col-lg-3">
        <div class="card p-2">
          <div class="d-flex align-items-center justify-content-between">
            <strong>Smart Folders</strong>
            <button class="btn btn-sm btn-outline-secondary" id="refresh-smart"><i class="fa-solid fa-rotate"></i></button>
          </div>
          <div id="smart-folders" class="small mt-2 text-muted">Loading…</div>
        </div>
      </div>
      <div class="col-12 col-lg-9">
        <div id="notes">Loading…</div>
      </div>
    </div>
  </main>

  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="app-toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="app-toast-body">Done.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/lunr@2.3.9/lunr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

  <script type="module" src="js/app.js"></script>
  <script type="module">
    import { storage } from './js/storage.js';
    import { toMarkdown, toHTML, toPDF } from './js/notes/exporters.js';
    import * as SS from './js/search/savedSearches.js';
    import { FLAGS } from './js/flags.js';
    import * as SS from './js/search/savedSearches.js';
    import { exportNoteToMarkdown, exportNoteToHTML, exportNoteToPDF } from './js/notes/exports.js';


    const $ = (s, r=document) => r.querySelector(s);
    const notesBox = $('#notes');
    const smartBox = $('#smart-folders');
    const q = $('#q'); const clearQ = $('#clear-q');
    const docFilter = $('#doc-filter'); const sortSel = $('#sort'); const onlyTagged = $('#only-tagged');

    let allDocs = []; let allAnns = []; let idx = null;

    const toast = (msg, type='primary') => {
      const el = document.getElementById('app-toast'); const body = document.getElementById('app-toast-body');
      body.textContent = msg; el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, {autohide:true, delay:1600}).show();
    };

    function esc(s=''){ return (s+'').replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
    function getQuote(a){ return a.quote ?? a.text ?? ''; }
    function getBody(a){ return a.note ?? (a.kind==='note' ? a.text : '') ?? ''; }
    function getWhen(a){ return a.updatedAt || a.createdAt || null; }
    function getTags(a){ return Array.isArray(a.tags) ? a.tags : []; }

    function buildDocSelect(selectEl){
      selectEl.innerHTML = `<option value="">All documents</option>` +
        allDocs.slice().sort((a,b)=>(a.title||'').localeCompare(b.title||''))
               .map(d=>`<option value="${d.id}">${esc(d.title||'(Untitled)')}</option>`).join('');
    }

    function buildIndex(){
      if (!window.lunr) { idx = null; return; }
      idx = lunr(function(){
        this.ref('id'); this.field('title'); this.field('quote'); this.field('body'); this.field('tags');
        allAnns.forEach(a=>{
          const doc = allDocs.find(d=>d.id===a.documentId);
          this.add({
            id: a.id, title: (doc?.title)||'',
            quote: getQuote(a)||'', body: getBody(a)||'',
            tags:  getTags(a).join(' ')
          });
        });
      });
    }

    function filterAndSort(){
      const term = (q.value||'').trim();
      const docId = docFilter?.value || '';
      const sort  = sortSel?.value || 'newest';
      const tagged= !!(onlyTagged?.checked);
      let set = [...allAnns];
      if (docId) set = set.filter(a => a.documentId === docId);
      if (tagged) set = set.filter(a => getTags(a).length > 0);
      if (term){
        if (idx){
          try { const hits = idx.search(term); const ids = new Set(hits.map(h=>h.ref)); set = set.filter(a=>ids.has(a.id)); }
          catch { set = set.filter(a => matchTerm(a, term)); }
        } else { set = set.filter(a => matchTerm(a, term)); }
      }
      set.sort((a,b)=> (sort==='oldest')
        ? new Date(getWhen(a)||0) - new Date(getWhen(b)||0)
        : new Date(getWhen(b)||0) - new Date(getWhen(a)||0));
      return set;
    }
    function matchTerm(a, t){
      const T = t.toLowerCase();
      return (getQuote(a).toLowerCase().includes(T)) ||
             (getBody(a).toLowerCase().includes(T)) ||
             getTags(a).some(x=>(x||'').toLowerCase().includes(T));
    }

    function renderList(list){
  if (!list.length){ notesBox.innerHTML = `<div class="text-muted">No notes yet.</div>`; return; }

  const map = Object.fromEntries(allDocs.map(d => [d.id, d]));
  const rows = list.map(a=>{
    const d = map[a.documentId];
    const title = esc(d?.title || '(Unknown doc)');
    const when = getWhen(a) ? new Date(getWhen(a)).toLocaleString() : '';
    const tags = getTags(a).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
    const quote = esc(getQuote(a));
    const body  = esc(getBody(a));
    const openLink = d ? `reader.html?doc=${encodeURIComponent(d.id)}` : '#';
    const nid = a.id;

    return `
      <div class="note-card" data-id="${nid}">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold text-truncate" title="${title}">${title}</div>
          <div class="note-actions btn-group btn-group-sm">
            <a class="btn btn-outline-primary" href="${openLink}" title="Open in Reader">
              <i class="fa-solid fa-arrow-up-right-from-square"></i>
            </a>
            <button class="btn btn-outline-secondary" data-copy="${nid}" title="Copy">
              <i class="fa-regular fa-copy"></i>
            </button>
            <div class="btn-group">
              <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Export">
                <i class="fa-solid fa-file-export"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item" data-exp-md="${nid}">Markdown (.md)</button></li>
                <li><button class="dropdown-item" data-exp-html="${nid}">HTML (.html)</button></li>
                <li><button class="dropdown-item" data-exp-pdf="${nid}">PDF (print)</button></li>
              </ul>
            </div>
          </div>
        </div>
        ${when ? `<div class="text-muted small mt-1">${when}</div>` : ``}
        ${quote ? `<div class="mt-2"><em class="truncate-2">“${quote}”</em></div>` : ``}
        ${body  ? `<div class="mt-2">${body}</div>` : ``}
        ${tags  ? `<div class="mt-2">${tags}</div>` : ``}
      </div>`;
  }).join('');

  notesBox.innerHTML = rows;

  // Copy handlers
  notesBox.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-copy');
      const a = list.find(x=>x.id===id);
      const txt = [getQuote(a), getBody(a)].filter(Boolean).join('\n\n');
      navigator.clipboard.writeText(txt).then(()=>toast('Copied','success'));
    });
  });

  // Export handlers
  function noteMeta(note){
    const doc = allDocs.find(d=>d.id===note.documentId);
    return {
      title: note.title || (doc?.title ? (doc.title + ' — Note') : 'Note'),
      body: (note.note || note.text || ''),
      quote: (note.quote || ''),
      tags: getTags(note),
      meta: {
        title: doc?.title || '',
        author: doc?.author || '',
        date: note.updatedAt || note.createdAt || '',
        range: '' // optional page or chapter range if you store it
      }
    };
  }
  notesBox.querySelectorAll('[data-exp-md]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-exp-md');
      const n = list.find(x=>x.id===id); if (!n) return;
      exportNoteToMarkdown(noteMeta(n));
    });
  });
  notesBox.querySelectorAll('[data-exp-html]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-exp-html');
      const n = list.find(x=>x.id===id); if (!n) return;
      exportNoteToHTML(noteMeta(n));
    });
  });
  notesBox.querySelectorAll('[data-exp-pdf]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-exp-pdf');
      const n = list.find(x=>x.id===id); if (!n) return;
      exportNoteToPDF(noteMeta(n));
    });
  });
}


    function downloadText(text, filename, mime){
      const blob = new Blob([text], {type:mime||'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    async function loadAll(){
      await storage.init?.();
      allDocs = await (storage.getDocuments?.() || []);
      allAnns = await (storage.getAllAnnotations?.() || []);
      buildDocSelect(docFilter);
      buildIndex();
      renderList(filterAndSort());
      if (FLAGS.savedSearches) renderSmartFolders();
    }

    function applySavedSearch(s){
      q.value = s.query || '';
      docFilter.value = s.filters?.docId || '';
      sortSel.value = s.sort || 'newest';
      onlyTagged.checked = !!(s.filters?.tags?.length);
      renderList(filterAndSort());
    }

    async function renderSmartFolders(){
      const items = await SS.list();
      if (!items.length){ smartBox.innerHTML = `<div class="text-muted">No smart folders yet.</div>`; return; }
      smartBox.innerHTML = `<div id="sf-list">${items.map(i=>`
        <div class="d-flex justify-content-between align-items-center mb-1" draggable="true" data-id="${i.id}">
          <a href="#" class="text-truncate me-2" title="${esc(i.title)}" data-open="${i.id}">${esc(i.title)}</a>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" data-rename="${i.id}"><i class="fa-regular fa-pen-to-square"></i></button>
            <button class="btn btn-outline-danger" data-del="${i.id}"><i class="fa-regular fa-trash-can"></i></button>
          </div>
        </div>`).join('')}</div>
        <div class="small text-muted">Drag to reorder</div>`;

      // open
      smartBox.querySelectorAll('[data-open]').forEach(a=>{
        a.onclick = async (e)=>{ e.preventDefault(); const i = (await SS.list()).find(x=>x.id===a.dataset.open); if (i) applySavedSearch(i); };
      });
      // rename
      smartBox.querySelectorAll('[data-rename]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.rename;
          const items = await SS.list();
          const it = items.find(x=>x.id===id); if (!it) return;
          const t = prompt('New title', it.title||''); if (t===null) return;
          await SS.save({...it, title: t.trim()});
          renderSmartFolders();
        };
      });
      // delete
      smartBox.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = async ()=>{ await SS.remove(btn.dataset.del); renderSmartFolders(); };
      });
      // drag reorder
      const listEl = document.getElementById('sf-list');
      let dragId = null;
      listEl.addEventListener('dragstart', e => { dragId = e.target.closest('[data-id]')?.dataset.id || null; });
      listEl.addEventListener('dragover', e => e.preventDefault());
      listEl.addEventListener('drop', async e => {
        e.preventDefault();
        const over = e.target.closest('[data-id]'); if (!dragId || !over) return;
        const overId = over.dataset.id;
        const order = [...listEl.querySelectorAll('[data-id]')].map(x=>x.dataset.id);
        // move dragId before overId
        const without = order.filter(x=>x!==dragId);
        const idx = without.indexOf(overId);
        without.splice(idx, 0, dragId);
        await SS.reorder(without);
        renderSmartFolders();
      });
    }

    // UI bindings
    q.addEventListener('input', ()=> renderList(filterAndSort()));
    clearQ.addEventListener('click', ()=> { q.value=''; renderList(filterAndSort()); });
    docFilter.addEventListener('change', ()=> renderList(filterAndSort()));
    sortSel.addEventListener('change',   ()=> renderList(filterAndSort()));
    onlyTagged.addEventListener('change',()=> renderList(filterAndSort()));
    document.getElementById('refresh-smart').onclick = ()=> renderSmartFolders();

    document.getElementById('save-search').onclick = async ()=>{
      const title = prompt('Smart folder title:','My Search'); if (!title) return;
      const payload = {
        title: title.trim(),
        query: q.value || '',
        filters: { docId: docFilter.value || '', tags: onlyTagged.checked ? ['*'] : [] },
        sort: sortSel.value || 'newest'
      };
      await SS.save(payload);
      toast('Saved','success');
      renderSmartFolders();
    };

    (async ()=>{ await loadAll(); })();

    document.getElementById('save-smart')?.addEventListener('click', async ()=>{
  const title = prompt('Smart folder title','My search');
  if (!title) return;
  const state = {
    title,
    query: q.value || '',
    filters: { docId: (docFilter?.value || '' ) || null, taggedOnly: !!onlyTagged?.checked },
    sort: sortSel?.value || 'newest'
  };
  await SS.saveFromCurrent(state);
  toast('Saved to Smart Folders','success');
});

  </script>
</body>
</html>
