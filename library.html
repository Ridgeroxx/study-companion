<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Library â€¢ Study Companion</title>

  <!-- PWA / theme color (light/dark aware) -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#136FF2">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1324">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- App icons -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Ctext y='1em' font-size='96'%3EðŸ“š%3C/text%3E%3C/svg%3E" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <!-- localForage before storage.js uses it -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

  <style>
    /* Compat */
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    :root { --topbar-h: 56px; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(13,110,253,.06), transparent),
        radial-gradient(1000px 500px at 110% 120%, rgba(102,16,242,.06), transparent);
      background-color: var(--bs-body-bg);
    }

    /* Topbar */
    .nav-3d{
      position: sticky; top: 0; z-index: 1030;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.62));
      border-bottom: 1px solid rgba(0,0,0,.06);
      min-height: var(--topbar-h);
    }
    [data-bs-theme="dark"] .nav-3d{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-color: rgba(255,255,255,.14);
    }
    .brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; font-weight:800; letter-spacing:.2px; }
    .brand img { width:28px; height:28px; border-radius:6px; }

    /* Bottom nav */
    .bottom-nav{
      position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
      display:flex; z-index: 1040;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      background: rgba(255,255,255,.82);
      border-top: 1px solid rgba(0,0,0,.06);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-bs-theme="dark"] .bottom-nav{
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
    }
    .bottom-nav a{
      flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px; font-size:12px; text-decoration:none; color:inherit; opacity:.85;
    }
    .bottom-nav a .fa-solid{ font-size:18px; }
    .bottom-nav a.active{ font-weight:700; opacity:1; }

    /* Content spacing to avoid overlapping bottom nav */
    .with-bottom-nav { padding-bottom: calc(84px + env(safe-area-inset-bottom, 0px)); }

    /* Page-specific */
    .toolbar{ gap:.5rem; flex-wrap:wrap }
    .toolbar .form-control, .toolbar .form-select{ min-width: 220px; }

    .dropzone{
      display:none;
      border:2px dashed #cfe2ff;
      border-radius:12px;
      padding:1rem;
      text-align:center;
      color:#0a58ca;
      background:#f8fbff;
      margin-bottom: 1rem;
    }
    .dropzone.active{
      display:block;
      border-color:#0d6efd;
      background:#eef4ff;
    }

    .card-row{
      border:1px solid #e9ecef; border-radius:12px; padding:.75rem; margin-bottom:.6rem; background:#fff;
    }
    .card-row .meta{ font-size:.825rem; color:#6c757d }
    .section-title{ font-weight:700; margin:.75rem 0 .5rem; color:#0d6efd }
    .empty{ color:#6c757d }
    .badge-type{ letter-spacing:.3px; }

    /* Dark mode polish */
    [data-bs-theme="dark"] .card-row{ background:#171717; border-color:rgba(255,255,255,.12) }
    [data-bs-theme="dark"] .meta, [data-bs-theme="dark"] .empty{ color:rgba(255,255,255,.7) }
    [data-bs-theme="dark"] .section-title{ color:#91b7ff }
    [data-bs-theme="dark"] .dropzone{ border-color:#294b86; background:#101827; color:#cfe2ff }

    .pill{ padding:.15rem .5rem; border-radius:999px; border:1px solid rgba(13,110,253,.25); }
    [data-bs-theme="dark"] .pill{ border-color:rgba(255,255,255,.2) }
  </style>

  <!-- set theme ASAP -->
  <script>
    (function(){
      try {
        const init = localStorage.getItem('app_theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', init);
      } catch {}
    })();
  </script>
</head>
<body>

  <!-- Topbar: logo left, language + theme right -->
  <nav class="navbar nav-3d">
    <div class="container-fluid">
      <a class="brand" href="app.html" aria-label="Study Companion" title="Study Companion">
        <img src="logo.png" alt="Logo"><span>Study Companion</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <!-- Language -->
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  aria-label="Change language"
                  title="Change language">
            <i class="fa-solid fa-language me-1" aria-hidden="true"></i>
            <span id="current-language">EN</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-label="Language menu">
            <li><button id="lang-en" class="dropdown-item" title="Switch to English">English</button></li>
            <li><button id="lang-es" class="dropdown-item" title="Cambiar a EspaÃ±ol">EspaÃ±ol</button></li>
          </ul>
        </div>
        <!-- Theme -->
        <button class="btn btn-sm btn-outline-secondary" id="theme-toggle"
                aria-label="Toggle theme" title="Toggle theme">
          <i class="fa-solid fa-moon" aria-hidden="true"></i>
          <span class="visually-hidden">Toggle theme</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="container my-3 with-bottom-nav">
    <!-- Toolbar -->
    <div class="d-flex toolbar mb-3" role="search" aria-label="Library search and sort">
      <label for="q" class="visually-hidden">Search library</label>
      <input id="q" class="form-control" placeholder="Search by title or typeâ€¦" aria-label="Search library"/>

      <label for="sort" class="visually-hidden">Sort library</label>
      <select id="sort" class="form-select" aria-label="Sort library">
        <option value="recent" selected>Sort: Recent</option>
        <option value="title">Sort: Title (Aâ†’Z)</option>
        <option value="type">Sort: Type</option>
      </select>

      <button class="btn btn-sm btn-primary ms-auto" id="btn-import" title="Import documents" aria-label="Import documents">
        <i class="fa-solid fa-upload me-1" aria-hidden="true"></i>Import
      </button>

      <span class="pill small text-muted" id="stats" aria-live="polite">â€”</span>
    </div>

    <!-- Drag & drop zone (appears only when dragging files) -->
    <div id="dropzone" class="dropzone" role="region" aria-label="Drop files to import">
      <i class="fa-solid fa-cloud-arrow-up me-1" aria-hidden="true"></i>
      Drop files to import (EPUB, PDF, DOCX, TXT, MD)
    </div>

    <div id="lib-favorites"></div>
    <div id="lib-recent"></div>
    <div id="lib-all"></div>
    <hr>
    <div id="lib-trash"></div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Primary">
    <a href="app.html" data-page="home" title="Home">
      <i class="fa-solid fa-house" aria-hidden="true"></i><span>Home</span>
    </a>
    <a href="library.html" data-page="library" title="Library">
      <i class="fa-solid fa-book" aria-hidden="true"></i><span>Library</span>
    </a>
    <a href="notes.html" data-page="notes" title="Notes">
      <i class="fa-solid fa-note-sticky" aria-hidden="true"></i><span>Notes</span>
    </a>
    <a href="meetings.html" data-page="meetings" title="Meetings">
      <i class="fa-solid fa-calendar" aria-hidden="true"></i><span>Meetings</span>
    </a>
    <a href="reader.html" data-page="reader" title="Reader">
      <i class="fa-solid fa-grip" aria-hidden="true"></i><span>Reader</span>
    </a>
    <a href="settings.html" data-page="settings" title="Settings">
    <i class="fa-solid fa-gear" aria-hidden="true"></i><span>Settings</span>
    </a>
  </nav>

  <!-- Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body">Done</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="sw-register.js"></script>
  <script type="module" src="sw.js"></script>

  <script type="module">
    import { storage } from './js/storage.js';
    import { reader } from './js/reader.js'; // for import helpers

    // --- theme & language ---
    const THEME_KEY='app_theme'; const LANG_KEY='app_lang';
    try {
      const initLang = (localStorage.getItem(LANG_KEY) || 'EN').toUpperCase();
      const langEl = document.getElementById('current-language'); if (langEl) langEl.textContent = initLang;
    } catch {}
    document.getElementById('lang-en')?.addEventListener('click',()=>{ try{localStorage.setItem(LANG_KEY,'EN')}catch{}; const el=document.getElementById('current-language'); if(el) el.textContent='EN'; });
    document.getElementById('lang-es')?.addEventListener('click',()=>{ try{localStorage.setItem(LANG_KEY,'ES')}catch{}; const el=document.getElementById('current-language'); if(el) el.textContent='ES'; });
    document.getElementById('theme-toggle')?.addEventListener('click', ()=>{
      const curr=document.documentElement.getAttribute('data-bs-theme')||'light';
      const next=curr==='light'?'dark':'light';
      document.documentElement.setAttribute('data-bs-theme', next);
      try{localStorage.setItem(THEME_KEY,next)}catch{}
    });

    // --- bottom nav active ---
    document.querySelectorAll('.bottom-nav a').forEach(a=>{
      if (a.dataset.page === 'library') a.classList.add('active');
    });

    // --- toast helper ---
    const toast = (msg, type='primary') => {
      const el = document.getElementById('toast');
      const body = document.getElementById('toast-body');
      body.textContent = msg;
      el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, { autohide: true, delay: 1800 }).show();
    };

    // --- DOM refs ---
    const boxFav = document.getElementById('lib-favorites');
    const boxRec = document.getElementById('lib-recent');
    const boxAll = document.getElementById('lib-all');
    const boxTrash = document.getElementById('lib-trash');
    const q = document.getElementById('q');
    const sortSel = document.getElementById('sort');
    const stats = document.getElementById('stats');
    const dropzone = document.getElementById('dropzone');

    // --- state ---
    let allDocs = [];
    let favIds = [];
    let trashed = [];
    let active = [];
    let searchTerm = '';
    let sortKey = 'recent';

    // --- render helpers ---
    const itemRow = (d, opts={trashed:false, isFav:false}) => `
      <div class="card-row d-flex justify-content-between align-items-center shadow-sm">
        <div class="me-2">
          <div class="fw-semibold">${escapeHtml(d.title || '(Untitled)')}</div>
          <div class="meta">
            <span class="badge text-bg-light badge-type">${(d.type || '').toUpperCase()}</span>
            Â· ${new Date(d.updatedAt || d.createdAt || Date.now()).toLocaleString()}
          </div>
        </div>
        <div class="btn-group btn-group-sm" role="group" aria-label="Item actions">
          ${
            opts.trashed
            ? `
              <button class="btn btn-outline-secondary" data-restore="${d.id}" title="Restore" aria-label="Restore">
                <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
              </button>
              <button class="btn btn-outline-danger" data-harddel="${d.id}" title="Delete forever" aria-label="Delete forever">
                <i class="fa-solid fa-trash" aria-hidden="true"></i>
              </button>
            `
            : `
              <button class="btn btn-outline-primary" data-open="${d.id}" title="Open" aria-label="Open">
                <i class="fa-solid fa-folder-open" aria-hidden="true"></i>
              </button>
              <button class="btn btn-outline-warning" data-fav="${d.id}" title="${opts.isFav?'Unfavorite':'Favorite'}" aria-label="${opts.isFav?'Unfavorite':'Favorite'}">
                <i class="fa${opts.isFav?'s':'-regular'} fa-star" aria-hidden="true"></i>
              </button>
              <button class="btn btn-outline-danger" data-softdel="${d.id}" title="Move to Trash" aria-label="Move to Trash">
                <i class="fa-solid fa-trash" aria-hidden="true"></i>
              </button>
            `
          }
        </div>
      </div>`;

    const section = (title, listHtml, emptyText) => `
      <div class="section">
        <div class="section-title">${title}</div>
        ${listHtml || `<div class="empty">${emptyText}</div>`}
      </div>`;

    function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; }

    // --- actions (with fallbacks for older storage builds) ---
    async function hardDeleteDoc(id){
      if (!confirm('Permanently delete this item? This cannot be undone.')) return;
      try {
        if (typeof storage.hardDeleteDocument === 'function') {
          await storage.hardDeleteDocument(id);
        } else {
          await storage.deleteDocument?.(id);
        }
        toast('Deleted permanently', 'danger');
        await refresh();
      } catch (e) { console.error(e); toast('Delete failed', 'danger'); }
    }
    async function softDeleteDoc(id){
      if (!confirm('Move this item to Trash?')) return;
      try {
        if (typeof storage.softDeleteDocument === 'function') {
          await storage.softDeleteDocument(id);
        } else {
          // fallback: emulate soft delete
          const docs = await storage.getDocuments();
          const idx = docs.findIndex(d=>d.id===id);
          if (idx !== -1) { docs[idx].deletedAt = new Date().toISOString(); await storage.setItem?.('documents', docs); }
        }
        toast('Moved to Trash', 'secondary');
        await refresh();
      } catch (e) { console.error(e); toast('Failed to move to Trash', 'danger'); }
    }
    async function restoreDoc(id){
      try {
        if (typeof storage.restoreDocument === 'function') {
          await storage.restoreDocument(id);
        } else {
          const docs = await storage.getDocuments();
          const idx = docs.findIndex(d=>d.id===id);
          if (idx !== -1) { delete docs[idx].deletedAt; await storage.setItem?.('documents', docs); }
        }
        toast('Restored', 'primary');
        await refresh();
      } catch (e) { console.error(e); toast('Restore failed', 'danger'); }
    }
    async function toggleFav(id){
      try {
        if (typeof storage.toggleFavorite === 'function') {
          await storage.toggleFavorite(id);
        } else {
          const key = 'favorites';
          const cur = (await storage.getItem?.(key)) || [];
          const next = cur.includes(id) ? cur.filter(x=>x!==id) : [...cur, id];
          await storage.setItem?.(key, next);
        }
        await refresh();
      } catch (e) { console.error(e); toast('Failed to toggle favorite', 'danger'); }
    }
    function openDoc(id){
      location.href = 'reader.html?doc=' + encodeURIComponent(id);
    }

    // --- import button ---
    document.getElementById('btn-import').addEventListener('click', async () => {
      try {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.epub,.pdf,.docx,.txt,.md';
        input.multiple = true;
        input.onchange = async () => {
          const files = Array.from(input.files || []);
          if (!files.length) return;
          let ok = 0;
          for (const f of files) {
            try{
              // Prefer storage.importFile if available (keeps your existing flow)
              const doc = await (storage.importFile ? storage.importFile(f) : reader.importPdf(f));
              if (doc?.id) ok++;
            }catch(e){ console.warn('import error', e); }
          }
          toast(ok ? `Imported ${ok} file(s)` : 'Import failed', ok ? 'success' : 'danger');
          await refresh();
        };
        input.click();
      } catch (e) { console.error(e); toast('Import failed', 'danger'); }
    });

    // --- drag & drop importing ---
    let dragCount = 0;
    ['dragenter','dragover'].forEach(ev =>
      document.addEventListener(ev, (e)=>{
        if (!e.dataTransfer?.types?.includes('Files')) return;
        e.preventDefault(); e.stopPropagation();
        dragCount++; dropzone.classList.add('active');
      }, false)
    );
    ['dragleave','drop'].forEach(ev =>
      document.addEventListener(ev, (e)=>{
        if (!e.dataTransfer?.types?.includes('Files')) return;
        e.preventDefault(); e.stopPropagation();
        dragCount = Math.max(0, dragCount-1);
        if (dragCount===0) dropzone.classList.remove('active');
      }, false)
    );
    document.addEventListener('drop', async (e)=>{
      const files = Array.from(e.dataTransfer?.files || []);
      if (!files.length) return;
      let ok = 0;
      for (const f of files) {
        try{
          const doc = await (storage.importFile ? storage.importFile(f) : null);
          if (doc?.id) ok++;
        }catch(err){ console.warn('drop import error', err); }
      }
      toast(ok ? ('Imported ' + ok + ' file(s)') : 'Import failed', ok ? 'success' : 'danger');
      await refresh();
    }, false);

    // --- main render ---
    function applySearchAndSort(list){
      let out = list;
      if (searchTerm) {
        const t = searchTerm.toLowerCase();
        out = out.filter(d =>
          (d.title||'').toLowerCase().includes(t) ||
          (d.type||'').toLowerCase().includes(t)
        );
      }
      if (sortKey === 'title') {
        out = out.slice().sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      } else if (sortKey === 'type') {
        out = out.slice().sort((a,b)=> (a.type||'').localeCompare(b.type||'') || (a.title||'').localeCompare(b.title||''));
      } else {
        // recent
        out = out.slice().sort((a,b)=>{
          const ta = new Date(a.lastOpened || a.updatedAt || a.createdAt || 0).getTime();
          const tb = new Date(b.lastOpened || b.updatedAt || b.createdAt || 0).getTime();
          return tb - ta;
        });
      }
      return out;
    }

    function render(){
      const favDocs = active.filter(d => favIds.includes(d.id));
      const recent   = applySearchAndSort(active).slice(0, 10);
      const all      = applySearchAndSort(active);
      const tr       = applySearchAndSort(trashed);

      stats.textContent = `${all.length} items (${favDocs.length} favorites, ${trashed.length} in trash)`;

      boxFav.innerHTML = section('Favorites',
        favDocs.map(d => itemRow(d, { isFav:true, trashed:false })).join(''),
        'No favorites yet.'
      );

      boxRec.innerHTML = section('Recent',
        recent.map(d => itemRow(d, { isFav: favIds.includes(d.id), trashed:false })).join(''),
        'Nothing recent.'
      );

      boxAll.innerHTML = section('All',
        all.map(d => itemRow(d, { isFav: favIds.includes(d.id), trashed:false })).join(''),
        'Your library is empty. Click Import to add files.'
      );

      boxTrash.innerHTML = section('Trash',
        tr.map(d => itemRow(d, { trashed:true })).join(''),
        'Trash is empty.'
      );

      delegateClicks();
    }

    function delegateClicks(){
      // open
      document.querySelectorAll('[data-open]').forEach(b => b.onclick = () => openDoc(b.getAttribute('data-open')));
      // fav
      document.querySelectorAll('[data-fav]').forEach(b => b.onclick = () => toggleFav(b.getAttribute('data-fav')));
      // soft delete
      document.querySelectorAll('[data-softdel]').forEach(b => b.onclick = () => softDeleteDoc(b.getAttribute('data-softdel')));
      // hard delete
      document.querySelectorAll('[data-harddel]').forEach(b => b.onclick = () => hardDeleteDoc(b.getAttribute('data-harddel')));
      // restore
      document.querySelectorAll('[data-restore]').forEach(b => b.onclick = () => restoreDoc(b.getAttribute('data-restore')));
    }

    async function refresh(){
      // (Re)load data then render with current filters/sort
      await storage.init?.();
      allDocs = await storage.getDocuments() || [];
      favIds = (await storage.getFavorites?.()) || [];
      active = allDocs.filter(d => !d.deletedAt);
      trashed = allDocs.filter(d => !!d.deletedAt);
      render();
    }

    // live search/sort
    q.addEventListener('input', ()=>{ searchTerm = (q.value||'').trim(); render(); });
    sortSel.addEventListener('change', ()=>{ sortKey = sortSel.value; render(); });

    // boot
    document.addEventListener('DOMContentLoaded', refresh);
  </script>
</body>
</html>
