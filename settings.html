<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Settings — Study Companion</title>

  <!-- PWA / theme -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#136FF2">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1324">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/logo.png">
  <link rel="icon" href="icons/logo.png">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    img-src 'self' data: blob:;
    font-src 'self' data: https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    style-src-elem 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
    connect-src 'self' blob:;
    worker-src 'self' blob: https://cdnjs.cloudflare.com;
    object-src 'none';
    base-uri 'self';
    upgrade-insecure-requests;
  ">

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <!-- Styles -->
  <style>
    /* Compat */
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    :root { --topbar-h: 56px; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(13,110,253,.06), transparent),
        radial-gradient(1000px 500px at 110% 120%, rgba(102,16,242,.06), transparent);
      background-color: var(--bs-body-bg);
      min-height:100vh;
    }

    /* Topbar */
    .nav-3d{
      position: sticky; top: 0; z-index: 1030;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.62));
      border-bottom: 1px solid rgba(0,0,0,.06);
      min-height: var(--topbar-h);
    }
    [data-bs-theme="dark"] .nav-3d{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-color: rgba(255,255,255,.14);
    }
    .brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; font-weight:800; letter-spacing:.2px; }
    .brand img { width:28px; height:28px; border-radius:6px; }

    /* Bottom nav */
    .bottom-nav{
      position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
      display:flex; z-index: 1040;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      background: rgba(255,255,255,.82);
      border-top: 1px solid rgba(0,0,0,.06);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-bs-theme="dark"] .bottom-nav{
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
    }
    .bottom-nav a{
      flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px; font-size:12px; text-decoration:none; color:inherit; opacity:.85;
    }
    .bottom-nav a .fa-solid{ font-size:18px; }
    .bottom-nav a.active{ font-weight:700; opacity:1; }

    /* Content spacing to avoid overlap with bottom nav */
    .with-bottom-nav { padding-bottom: calc(84px + env(safe-area-inset-bottom, 0px)); }

    .cardish {
      border:1px solid rgba(0,0,0,.06);
      border-radius: 14px;
      padding: 16px;
      background: var(--bs-body-bg);
    }
    [data-bs-theme="dark"] .cardish { border-color: rgba(255,255,255,.12); }

    .section-title { font-weight:700; letter-spacing:.2px; }
    .small-muted { color: var(--bs-secondary-color); }
  </style>

  <!-- set theme ASAP -->
  <script>
    (function(){
      try {
        const init = localStorage.getItem('app_theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', init);
      } catch {}
    })();
  </script>
</head>
<body>
  <!-- Top bar -->
  <nav class="navbar nav-3d">
    <div class="container-fluid">
      <a class="brand" href="app.html" aria-label="Study Companion" title="Study Companion">
        <img src="logo.png" alt="Logo"><span>Study Companion</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <!-- Language -->
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  aria-label="Change language"
                  title="Change language">
            <i class="fa-solid fa-language me-1" aria-hidden="true"></i>
            <span id="current-language">EN</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-label="Language menu">
            <li><button id="lang-en" class="dropdown-item" title="Switch to English">English</button></li>
            <li><button id="lang-es" class="dropdown-item" title="Cambiar a Español">Español</button></li>
          </ul>
        </div>
        <!-- Theme -->
        <button class="btn btn-sm btn-outline-secondary" id="theme-toggle"
                aria-label="Toggle theme" title="Toggle theme">
          <i class="fa-solid fa-moon" aria-hidden="true"></i>
          <span class="visually-hidden">Toggle theme</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container py-3 with-bottom-nav">
    <h1 class="h5 section-title mb-3">Settings</h1>

    <div class="row g-3">
      <!-- Language & Appearance -->
      <div class="col-12 col-lg-6">
        <section class="cardish">
          <div class="section-title mb-2">Language & Appearance</div>

          <div class="mb-3">
            <label class="form-label">Language</label>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="set-lang-en" title="Switch to English" aria-label="Switch to English">English</button>
              <button class="btn btn-outline-secondary btn-sm" id="set-lang-es" title="Cambiar a Español" aria-label="Cambiar a Español">Español</button>
            </div>
            <div class="small small-muted mt-1">Affects UI labels; page content stays the same.</div>
          </div>

          <div class="mb-2">
            <label class="form-label">Theme</label>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" data-theme="light" title="Light theme" aria-label="Light theme">Light</button>
              <button class="btn btn-outline-secondary btn-sm" data-theme="dark" title="Dark theme" aria-label="Dark theme">Dark</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Data & Storage -->
      <div class="col-12 col-lg-6">
        <section class="cardish">
          <div class="section-title mb-2">Data & Storage</div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-primary" id="btn-export" title="Export a backup (JSON)" aria-label="Export backup">
              <i class="fa-solid fa-download me-1" aria-hidden="true"></i>Export backup
            </button>
            <button class="btn btn-sm btn-outline-primary" id="btn-import" title="Import a backup (JSON)" aria-label="Import backup">
              <i class="fa-solid fa-upload me-1" aria-hidden="true"></i>Import backup
            </button>
            <input id="import-input" type="file" accept="application/json,.json" class="visually-hidden" aria-hidden="true" tabindex="-1"/>
            <button class="btn btn-sm btn-outline-danger" id="btn-clear-library" title="Delete all documents and notes" aria-label="Delete all documents and notes">
              <i class="fa-solid fa-trash me-1" aria-hidden="true"></i>Clear library
            </button>
          </div>

          <hr/>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="btn-clear-cache" title="Clear offline cache" aria-label="Clear offline cache">
              <i class="fa-solid fa-broom me-1" aria-hidden="true"></i>Clear cache
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="btn-reload-sw" title="Reload service worker" aria-label="Reload service worker">
              <i class="fa-solid fa-rotate me-1" aria-hidden="true"></i>Reload service worker
            </button>
          </div>

          <div class="mt-3 small">
            <div><strong>Storage:</strong> <span id="storage-usage">—</span></div>
            <div><strong>App:</strong> <span id="app-name">Study Companion</span> <span id="app-version" class="text-muted"></span></div>
          </div>
        </section>
      </div>

      <!-- Notifications -->
      <div class="col-12 col-lg-6">
        <section class="cardish">
          <div class="section-title mb-2">Notifications</div>
          <p class="small small-muted mb-2">Enable reminders and alerts (browser permission).</p>
          <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-primary" id="btn-notify-perm" title="Request notification permission" aria-label="Request notification permission">
              <i class="fa-regular fa-bell me-1" aria-hidden="true"></i>Enable notifications
            </button>
            <span id="notify-status" class="small text-muted">Status: unknown</span>
          </div>
        </section>
      </div>

      <!-- About -->
      <div class="col-12 col-lg-6">
        <section class="cardish">
          <div class="section-title mb-2">About</div>
          <div class="small">
            Study Companion is an offline-first reader with notes, highlights, and planning tools.
          </div>
          <div class="small small-muted mt-1">All data is stored locally in your browser unless you export a backup.</div>
        </section>
      </div>
    </div>

    <div class="border rounded p-2">
  <div class="fw-semibold mb-1"><i class="fa-regular fa-bell me-1"></i>Study Reminder</div>
  <div class="d-flex gap-2 align-items-center">
    <label class="form-label m-0">Daily at:</label>
    <input type="time" id="study-reminder-time" class="form-control" style="max-width: 160px;">
    <button class="btn btn-primary btn-sm" id="study-reminder-save">Save</button>
  </div>
  <div class="small text-muted mt-1" id="study-reminder-status"></div>
</div>

  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Primary">
    <a href="app.html" data-page="home" title="Home">
      <i class="fa-solid fa-house" aria-hidden="true"></i><span>Home</span>
    </a>
    <a href="library.html" data-page="library" title="Library">
      <i class="fa-solid fa-book" aria-hidden="true"></i><span>Library</span>
    </a>
    <a href="notes.html" data-page="notes" title="Notes">
      <i class="fa-solid fa-note-sticky" aria-hidden="true"></i><span>Notes</span>
    </a>
    <a href="meetings.html" data-page="meetings" title="Meetings">
      <i class="fa-solid fa-calendar" aria-hidden="true"></i><span>Meetings</span>
    </a>
    <a href="reader.html" data-page="reader" title="Reader">
      <i class="fa-solid fa-grip" aria-hidden="true"></i><span>Reader</span>
    </a>
    <a href="settings.html" data-page="settings" title="Settings">
    <i class="fa-solid fa-gear" aria-hidden="true"></i><span>Settings</span>
    </a>
  </nav>

  <!-- Toast -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="app-toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="app-toast-body">Action completed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close toast"></button>
      </div>
    </div>
  </div>

  <!-- Vendor core -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

  <!-- App globals -->
  <script type="module" src="js/app.js"></script>
  <script type="module" src="js/reminders.js"></script>
  <script type="module" src="sw-register.js"></script>
  <script type="module" src="sw.js"></script>

  <!-- Page wiring -->
  <script type="module">
    import { storage } from './js/storage.js';

    const THEME_KEY='app_theme', LANG_KEY='app_lang';

    // Toast helper
    const toast = (msg, type='primary')=>{
      const el = document.getElementById('app-toast'); const body = document.getElementById('app-toast-body');
      if (!el || !body || !window.bootstrap) { console.log(msg); return; }
      body.textContent = msg;
      el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, {autohide:true, delay:1600}).show();
    };

    // Bottom nav: no "settings" item, so don't mark anything active

    // Language dropdown (top-right)
    try {
      const initLang = (localStorage.getItem(LANG_KEY) || 'EN').toUpperCase();
      const langEl = document.getElementById('current-language'); if (langEl) langEl.textContent = initLang;
    } catch {}

    document.getElementById('lang-en')?.addEventListener('click',()=>{ try{localStorage.setItem(LANG_KEY,'EN')}catch{}; const el=document.getElementById('current-language'); if(el) el.textContent='EN'; });
    document.getElementById('lang-es')?.addEventListener('click',()=>{ try{localStorage.setItem(LANG_KEY,'ES')}catch{}; const el=document.getElementById('current-language'); if(el) el.textContent='ES'; });

    // Theme toggle (top-right)
    document.getElementById('theme-toggle')?.addEventListener('click', ()=>{
      const curr=document.documentElement.getAttribute('data-bs-theme')||'light';
      const next=curr==='light'?'dark':'light';
      document.documentElement.setAttribute('data-bs-theme', next);
      try{localStorage.setItem(THEME_KEY,next)}catch{}
    });

    // Theme buttons inside the page
    document.querySelectorAll('[data-theme]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const theme = btn.getAttribute('data-theme');
        document.documentElement.setAttribute('data-bs-theme', theme);
        try{localStorage.setItem(THEME_KEY, theme)}catch{}
      });
    });

    // Quick language buttons inside the page
    document.getElementById('set-lang-en')?.addEventListener('click', ()=>{
      try{localStorage.setItem(LANG_KEY,'EN')}catch{}
      const el=document.getElementById('current-language'); if(el) el.textContent='EN';
      if (window.app?.setLanguage) { try{ window.app.setLanguage('en'); } catch {} }
      toast('Language set to English','secondary');
    });
    document.getElementById('set-lang-es')?.addEventListener('click', ()=>{
      try{localStorage.setItem(LANG_KEY,'ES')}catch{}
      const el=document.getElementById('current-language'); if(el) el.textContent='ES';
      if (window.app?.setLanguage) { try{ window.app.setLanguage('es'); } catch {} }
      toast('Idioma cambiado a Español','secondary');
    });

    // Storage usage
    async function updateStorageUsage(){
      try{
        if (navigator.storage && navigator.storage.estimate) {
          const {usage, quota} = await navigator.storage.estimate();
          const fmt = x => (x/1024/1024).toFixed(1) + ' MB';
          document.getElementById('storage-usage').textContent =
            (usage && quota) ? `${fmt(usage)} / ${fmt(quota)} (${Math.round(usage/quota*100)}%)` : '—';
        }
      } catch {}
    }

    // Manifest / version
    (async ()=>{
      try{
        const res = await fetch('manifest.webmanifest');
        const mf = await res.json();
        document.getElementById('app-name').textContent = mf.name || 'Study Companion';
        if (mf.version) document.getElementById('app-version').textContent = `v${mf.version}`;
      } catch {}
    })();

    // Export backup
    document.getElementById('btn-export')?.addEventListener('click', async ()=>{
      try{
        await storage.init?.();
        if (typeof storage.exportBackup === 'function') {
          const blob = await storage.exportBackup();
          downloadBlob(blob, 'study-companion-backup.json');
        } else {
          // Fallback: build a simple backup
          const data = {
            documents: await (storage.getDocuments?.() || []),
            favorites: await (storage.getFavorites?.() || []),
            notes:     await (storage.getMeetingNotes?.() || []),
            annotations: await (storage.getAllAnnotations?.() || []),
            createdAt: new Date().toISOString(),
            app: 'Study Companion',
            version: 1
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          downloadBlob(blob, 'study-companion-backup.json');
        }
        toast('Backup exported','success');
      } catch(e){ console.error(e); toast('Export failed','danger'); }
    });

    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    // Import backup
    const importInput = document.getElementById('import-input');
    document.getElementById('btn-import')?.addEventListener('click', ()=> importInput?.click());
    importInput?.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      try{
        await storage.init?.();
        if (typeof storage.importBackup === 'function') {
          await storage.importBackup(file);
        } else {
          const text = await file.text();
          const json = JSON.parse(text);
          // naive merge fallback
          const docs = Array.isArray(json.documents) ? json.documents : [];
          const favs = Array.isArray(json.favorites) ? json.favorites : [];
          const notes = Array.isArray(json.notes) ? json.notes : [];
          const anns = Array.isArray(json.annotations) ? json.annotations : [];

          // Persist via available APIs
          for (const d of docs) { try{ await storage.saveDocument?.(d); }catch{} }
          if (storage.setItem) { try{ await storage.setItem('favorites', favs); }catch{} }
          if (storage.saveMeetingNote && notes.length) {
            for (const n of notes) { try{ await storage.saveMeetingNote(n); }catch{} }
          }
          if (storage.saveAnnotations && anns.length) {
            for (const a of anns) { try{ await storage.saveAnnotations(a.docId, a.items||a); }catch{} }
          }
        }
        toast('Backup imported','success');
        updateStorageUsage();
      } catch(e){ console.error(e); toast('Import failed','danger'); }
      e.target.value = '';
    });

    // Clear library
    document.getElementById('btn-clear-library')?.addEventListener('click', async ()=>{
      if (!confirm('This will delete ALL documents, notes, and favorites on this device. Continue?')) return;
      try{
        if (typeof storage.clearAll === 'function') {
          await storage.clearAll();
        } else {
          // Fallback: rough clear
          await storage.clearDocuments?.();
          await storage.clearMeetingNotes?.();
          if (storage.setItem) await storage.setItem('favorites', []);
        }
        toast('Library cleared','danger');
        updateStorageUsage();
      } catch(e){ console.error(e); toast('Failed to clear library','danger'); }
    });

    // Clear cache
    document.getElementById('btn-clear-cache')?.addEventListener('click', async ()=>{
      try{
        if ('caches' in window) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
        toast('Cache cleared','secondary');
      } catch(e){ console.error(e); toast('Failed to clear cache','danger'); }
    });

    // Reload SW
    document.getElementById('btn-reload-sw')?.addEventListener('click', async ()=>{
      try{
        if ('serviceWorker' in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          await reg?.update();
          toast('Service worker reloaded','secondary');
        } else {
          toast('No service worker','secondary');
        }
      } catch(e){ console.error(e); toast('Failed to reload SW','danger'); }
    });

    // Notifications
    function updateNotifyStatus(){
      const st = Notification?.permission || 'unsupported';
      document.getElementById('notify-status').textContent = `Status: ${st}`;
    }
    document.getElementById('btn-notify-perm')?.addEventListener('click', async ()=>{
      try{
        if (!('Notification' in window)) { toast('Notifications unsupported','danger'); return; }
        const perm = await Notification.requestPermission();
        toast(perm === 'granted' ? 'Notifications enabled' : `Permission: ${perm}`, perm==='granted'?'success':'secondary');
        updateNotifyStatus();
      } catch(e){ console.error(e); toast('Request failed','danger'); }
    });

    document.querySelectorAll('.bottom-nav a').forEach(a=>{
     if (a.dataset.page === 'settings') a.classList.add('active');
    });


    // Init
    (async ()=>{
      try{ await storage.init?.(); }catch{}
      updateStorageUsage();
      updateNotifyStatus();
    })();
  </script>
</body>
</html>
