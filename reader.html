<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="mobile-web-app-capable" content="yes">
  <title>Reader â€” Study Companion</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#136FF2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- Use your existing icon files; change if you created /icons/ per earlier fix pack -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' rx='12' fill='%23136FF2'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='38' fill='white'%3ESC%3C/text%3E%3C/svg%3E">

  <!-- CSP (allows CDNs + blob CSS for print) -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      img-src 'self' data: blob:;
      font-src 'self' data: https://cdnjs.cloudflare.com;
      style-src 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
      style-src-elem 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
      script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
      connect-src 'self' blob:;
      worker-src 'self' blob: https://cdnjs.cloudflare.com;
      object-src 'none';
      base-uri 'self';
      upgrade-insecure-requests;
    ">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/dark.css">

  <!-- Vendor core (MUST load before any module that uses them) -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.92/dist/epub.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html,body{height:100%} body{margin:0; overflow:hidden}
    #reader-container{position:fixed; inset:0; display:flex; flex-direction:column; background:var(--bs-body-bg)}
    .reader-toolbar{display:flex; gap:.5rem; align-items:center; padding:.5rem; border-bottom:1px solid #e9ecef; background:var(--bs-body-bg); z-index:3}
    #viewer-wrap{position:absolute; inset:48px 0 0 0; overflow:auto}
    .pdf-page{box-shadow:0 2px 10px rgba(0,0,0,.06); background:#fff; margin:0 auto 16px}
    [data-bs-theme="dark"] .pdf-page{background:#111}
    .back-home{ position:fixed; top:8px; left:8px; z-index:2001; backdrop-filter: blur(4px); }
    .export-annotations{ position:fixed; top:8px; right:8px; z-index:2001; }
  </style>
</head>
<body>
  <!-- Back / Export buttons -->
  <a href="app.html" class="back-home btn btn-sm btn-outline-secondary bg-body">
    <i class="fa-solid fa-house"></i> <span class="d-none d-sm-inline">Home</span>
  </a>
  <button class="export-annotations btn btn-sm btn-outline-primary bg-body" id="export-annotations" title="Export annotations">
    <i class="fa-solid fa-download"></i>
  </button>

  <!-- Reader mount -->
  <div id="reader-container"></div>

  <!-- Toast -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="app-toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="app-toast-body">Action completed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- App bootstrap (global shell; OK after vendors) -->
  <script type="module" src="js/app.js"></script>

  <!-- Page logic (single, unified module) -->
  <script type="module">
    import { reader } from './js/reader.js';
    import { storage } from './js/storage.js';
    import { exportBookAnnotations } from './js/notes/exporters.js';

    const toast = (msg, type='primary')=>{
      const el = document.getElementById('app-toast'); const body = document.getElementById('app-toast-body');
      if (!el || !body || !window.bootstrap) { alert(msg); return; }
      body.textContent = msg;
      el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, {autohide:true, delay:1600}).show();
    };

    (async ()=>{
      try { await storage.init?.(); } catch {}
      const params = new URLSearchParams(location.search);
      const docId = params.get('doc');
      if (!docId) { location.replace('app.html'); return; }

      await reader.init();
      await reader.openDocument(docId, '#reader-container');

      // Export current document's annotations
      document.getElementById('export-annotations')?.addEventListener('click', async ()=>{
        try {
          const doc  = await storage.getDocument?.(docId);
          const anns = await (storage.getAnnotations?.(docId) || []);
          if (!anns.length) { toast('No annotations found for this document.', 'secondary'); return; }

          // Ask for format (md/html/pdf)
          const choice = (prompt('Export format? md / html / pdf', 'pdf') || '').trim().toLowerCase();
          const fmt = ['md','html','pdf'].includes(choice) ? choice : 'pdf';

          // One call handles all formats (MD/HTML download, PDF via print)
          exportBookAnnotations(
            { docMeta: { title: doc?.title || 'Untitled', author: doc?.author || '' }, annotations: anns },
            fmt
          );
        } catch (e) {
          console.error(e);
          toast('Export failed', 'danger');
        }
      });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
