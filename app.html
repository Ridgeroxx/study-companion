<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Study Companion — Home</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="application-name" content="Study Companion">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#0d6efd">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1324">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/logo.png">
  <link rel="icon" href="icons/logo.png">

  <!-- CSP (unchanged except allowing locales) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          img-src 'self' data: blob:;
          font-src 'self' data: https://cdnjs.cloudflare.com;
          style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
          style-src-elem 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
          script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
          connect-src 'self' blob: http://localhost:3000;
          worker-src 'self' blob: https://cdnjs.cloudflare.com;
          object-src 'none';
          base-uri 'self';
          upgrade-insecure-requests;
        ">

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <!-- App CSS (normalized design system + component fixes) -->
  <link href="styles.css" rel="stylesheet"/>

  <!-- Vendor libs your app already uses (kept) -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.92/dist/epub.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if(window['pdfjsLib']){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}</script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- API base for sync-local.js (unchanged; adjust if needed) -->
  <script>window.SC_API_BASE = window.SC_API_BASE || 'http://localhost:3000';</script>
</head>

<body>
  <!-- Topbar -->
  <nav class="navbar nav-3d sticky-top">
    <div class="container-fluid">
      <!-- Left: brand -->
      <a class="brand" href="app.html" aria-label="Study Companion" title="Study Companion">
        <img src="icons/logo.png" alt="Logo"><span>Study Companion</span>
      </a>

      <!-- Right: actions (aligned) -->
      <div class="d-flex align-items-center gap-2 ms-auto">
        <!-- Language: keep your IDs BUT use a select for i18n -->
        <div class="d-none">
          <!-- preserved for existing JS compatibility -->
          <button id="lang-en" class="btn btn-sm btn-outline-secondary">EN</button>
          <button id="lang-es" class="btn btn-sm btn-outline-secondary">ES</button>
          <span id="current-language" class="visually-hidden">EN</span>
        </div>

        <label class="visually-hidden" for="langSelect">Language</label>
        <select id="langSelect" class="form-select form-select-sm lang-select" aria-label="Language">
  <option value="en">English</option>
  <option value="es">Español</option>
  <option value="fr">Français</option>
</select>

        <button class="btn btn-icon" id="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
          <i class="fa-solid fa-moon" id="theme-icon"></i>
        </button>

        <!-- Auth dropdown (moved inside header, right-aligned) -->
        <div class="dropdown">
          <button class="btn btn-outline-primary btn-sm" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-user me-1"></i><span id="auth-label">Sign in</span>
          </button>
          <div class="dropdown-menu dropdown-menu-end p-2 auth-menu">
            <div id="auth-box-logged-out">
              <label class="visually-hidden" for="auth-email">Email</label>
              <input id="auth-email" class="form-control form-control-sm mb-1" type="email" placeholder="Email" autocomplete="username">
              <label class="visually-hidden" for="auth-pass">Password</label>
              <input id="auth-pass" class="form-control form-control-sm mb-2" type="password" placeholder="Password" autocomplete="current-password">
              <div class="d-flex gap-2">
                <button id="btn-login" class="btn btn-primary btn-sm w-100" data-i18n="login">Login</button>
                <button id="btn-register" class="btn btn-outline-secondary btn-sm w-100" data-i18n="register">Register</button>
              </div>
            </div>
            <div id="auth-box-logged-in" class="d-none">
              <div class="small mb-2">Signed in as <span id="auth-email-label"></span></div>
              <div class="d-flex gap-2">
                <button id="btn-sync-now" class="btn btn-outline-primary btn-sm w-100" data-i18n="sync_now">Sync now</button>
                <button id="btn-logout" class="btn btn-outline-danger btn-sm w-100" data-i18n="logout">Logout</button>
              </div>
            </div>
          </div>
        </div> <!-- /dropdown -->
      </div>
    </div>
  </nav>

  <main class="container py-3 with-bottom-nav">
    <!-- Quick Actions -->
    <section class="panel-3d mb-3">
      <div class="section-header">
        <div class="section-title"><i class="fa-solid fa-rocket me-2"></i><span data-i18n="quick_actions">Quick Actions</span></div>
        <div class="section-actions">
          <button class="btn btn-primary btn-3d" id="qa-continue" title="Continue reading">
            <i class="fa-solid fa-forward me-1"></i><span data-i18n="continue">Continue</span>
          </button>
          <button class="btn btn-outline-primary" id="qa-import" title="Import documents">
            <i class="fa-solid fa-upload me-1"></i><span data-i18n="import">Import</span>
          </button>
        </div>
      </div>

      <!-- Quick links row -->
      <div class="row gx-2 gy-2 mt-2">
        <div class="col-auto">
          <a class="btn btn-ghost" href="https://www.jw.org" target="_blank" rel="noopener">
            <i class="fa-solid fa-globe me-1"></i>jw.org
          </a>
        </div>
        <div class="col-auto">
          <a class="btn btn-ghost" href="https://www.jw.org/library/" target="_blank" rel="noopener">
            <i class="fa-solid fa-book-open me-1"></i>JW Library (web)
          </a>
        </div>
        <div class="col-auto">
          <a class="btn btn-ghost" href="record.html">
            <i class="fa-solid fa-microphone-lines me-1"></i><span data-i18n="record_talk">Record Talk</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Study Planner -->
    <section class="panel-3d mb-3">
      <div class="section-header">
        <div class="section-title"><i class="fa-regular fa-calendar-check me-2"></i><span data-i18n="study_planner">Study Planner</span></div>
        <div class="section-actions">
          <button class="btn btn-primary btn-3d" data-bs-toggle="modal" data-bs-target="#plannerModal" title="Add task">
            <i class="fa-solid fa-plus me-1"></i><span data-i18n="add">Add</span>
          </button>
          <button class="btn btn-outline-secondary" id="planner-filter-today" data-i18n="today">Today</button>
          <button class="btn btn-outline-secondary" id="planner-filter-week" data-i18n="this_week">This Week</button>
          <button class="btn btn-outline-secondary" id="planner-filter-all" data-i18n="all">All</button>
        </div>
      </div>
      <div id="planner-kanban" class="kanban">
        <div class="lane" data-lane="today">
          <div class="lane-title" data-i18n="today">Today</div>
          <div class="lane-body" id="kanban-today"></div>
        </div>
        <div class="lane" data-lane="week">
          <div class="lane-title" data-i18n="this_week">This Week</div>
          <div class="lane-body" id="kanban-week"></div>
        </div>
        <div class="lane" data-lane="later">
          <div class="lane-title" data-i18n="later">Later</div>
          <div class="lane-body" id="kanban-later"></div>
        </div>
      </div>
    </section>

    <!-- Upcoming / Timer / Stats -->
    <div class="row g-3">
      <div class="col-12 col-xl-6">
        <section class="panel-3d h-100">
          <div class="section-header">
            <div class="section-title"><i class="fa-regular fa-bell me-2"></i><span data-i18n="upcoming">Upcoming</span></div>
            <button class="btn btn-outline-primary" id="btn-enable-notifs">
              <i class="fa-regular fa-circle-check me-1"></i><span data-i18n="enable_alerts">Enable alerts</span>
            </button>
          </div>
          <div id="upcoming-list" class="small text-muted">Loading…</div>
        </section>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <section class="panel-3d h-100">
          <div class="section-title mb-2"><i class="fa-regular fa-hourglass-half me-2"></i><span data-i18n="focus_timer">Focus Timer</span></div>
          <div id="ftimer">
            <div class="display-5 text-center" id="ft-time" aria-live="polite">25:00</div>
            <div class="d-flex justify-content-center gap-2 my-2">
              <button class="btn btn-primary btn-sm" id="ft-start" title="Start"><i class="fa-solid fa-play"></i></button>
              <button class="btn btn-outline-secondary btn-sm" id="ft-pause" title="Pause"><i class="fa-solid fa-pause"></i></button>
              <button class="btn btn-outline-danger btn-sm" id="ft-reset" title="Reset"><i class="fa-solid fa-rotate-left"></i></button>
            </div>
            <div class="d-flex gap-2" role="group" aria-label="Select timer preset">
              <button class="btn btn-outline-secondary btn-sm w-100" data-ft="pomodoro">Pomodoro</button>
              <button class="btn btn-outline-secondary btn-sm w-100" data-ft="short">Short break</button>
              <button class="btn btn-outline-secondary btn-sm w-100" data-ft="long">Long break</button>
            </div>
          </div>
        </section>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <section class="panel-3d h-100">
          <div class="section-title mb-2"><i class="fa-solid fa-chart-line me-2"></i><span data-i18n="stats_streak">Stats & Streak</span></div>
          <div id="stats-box" class="small">Loading…</div>
        </section>
      </div>
    </div>

    <!-- Smart Folders / Tags -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-6">
        <section class="panel-3d h-100">
          <div class="section-header">
            <div class="section-title"><i class="fa-regular fa-folder-open me-2"></i><span data-i18n="smart_folders">Smart Folders</span></div>
            <a class="small" href="notes.html" title="Open Notes" data-i18n="open_notes">Open Notes</a>
          </div>
          <div id="smart-folders" class="small text-muted">No smart folders yet.</div>
        </section>
      </div>
      <div class="col-12 col-lg-6">
        <section class="panel-3d h-100">
          <div class="section-header">
            <div class="section-title"><i class="fa-solid fa-tags me-2"></i><span data-i18n="tags">Tags</span></div>
            <div class="small text-muted" data-i18n="from_highlights">From recent highlights</div>
          </div>
          <div id="tag-cloud" class="tag-cloud small text-muted">Loading…</div>
        </section>
      </div>
    </div>

    <!-- Masonry Highlights -->
    <section class="panel-3d my-3">
      <div class="section-header">
        <div class="section-title"><i class="fa-regular fa-highlighter me-2"></i><span data-i18n="masonry">Masonry Highlights</span></div>
        <div class="small text-muted" data-i18n="recent_quotes">Your recent quotes & notes</div>
      </div>
      <div id="masonry" class="masonry"></div>
    </section>

    <!-- Quick Capture -->
    <section class="panel-3d mb-3">
      <div class="section-header">
        <div class="section-title"><i class="fa-regular fa-note-sticky me-2"></i><span data-i18n="quick_capture">Quick Capture</span></div>
        <div class="section-actions">
          <button class="btn btn-outline-secondary btn-sm" id="qc-clear" data-i18n="clear">Clear</button>
          <button class="btn btn-primary btn-sm" id="qc-save"><i class="fa-solid fa-save me-1"></i><span data-i18n="save">Save</span></button>
        </div>
      </div>
      <label for="qc-text" class="visually-hidden">Quick capture</label>
      <textarea id="qc-text" class="form-control mt-2" rows="3" placeholder="Write a quick thought…"></textarea>
    </section>

  </main>

  <!-- Bottom Navigation (kept) -->
  <nav class="bottom-nav" role="navigation" aria-label="Primary">
    <a href="app.html" data-page="home" title="Home"><i class="fa-solid fa-house"></i><span data-i18n="home">Home</span></a>
    <a href="library.html" data-page="library" title="Library"><i class="fa-solid fa-book"></i><span data-i18n="library">Library</span></a>
    <a href="notes.html" data-page="notes" title="Notes"><i class="fa-solid fa-note-sticky"></i><span data-i18n="notes">Notes</span></a>

    <div class="dropup bn-item">
      <button class="bn-button" data-bs-toggle="dropdown" aria-expanded="false" title="Schedule">
        <i class="fa-solid fa-calendar"></i><span data-i18n="schedule">Schedule</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item d-flex align-items-center gap-2" href="meetings.html"><i class="fa-solid fa-calendar-day"></i><span data-i18n="meetings">Meetings</span></a></li>
        <li><a class="dropdown-item d-flex align-items-center gap-2" href="convention.html"><i class="fa-solid fa-tent"></i><span data-i18n="convention">Convention</span></a></li>
      </ul>
    </div>

    <a href="reader.html" data-page="reader" title="Reader"><i class="fa-solid fa-grip"></i><span data-i18n="reader">Reader</span></a>
    <a href="settings.html" data-page="settings" title="Settings"><i class="fa-solid fa-gear"></i><span data-i18n="settings">Settings</span></a>

    <span class="bn-indicator" aria-hidden="true"></span>
  </nav>

  <!-- Import Modal (kept IDs) -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true" aria-labelledby="importModalTitle">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-16">
        <div class="modal-header">
          <h5 class="modal-title" id="importModalTitle"><i class="fa-solid fa-upload me-2"></i><span data-i18n="import_documents">Import documents</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close import dialog" title="Close"></button>
        </div>
        <div class="modal-body">
          <div id="dropzone" class="p-3 border rounded-16 text-center" role="region" aria-label="Drag and drop files to import">
            <div class="mb-2"><i class="fa-solid fa-cloud-arrow-up fs-2"></i></div>
            <div class="fw-semibold mb-1" data-i18n="drag_drop">Drag & drop files here</div>
            <div class="text-muted small mb-3">EPUB, PDF, DOCX, TXT, MD</div>
            <button class="btn btn-primary btn-sm" id="import-choose-btn" title="Choose files" data-i18n="choose_files">Choose files</button>
            <input type="file" id="import-input" class="d-none" multiple accept=".epub,.pdf,.docx,.txt,.md,application/epub+zip,application/pdf"/>
          </div>
          <div class="mt-3">
            <div class="small text-muted mb-1" data-i18n="recently_added">Recently added</div>
            <div id="recent-imports" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="done">Done</button></div>
      </div>
    </div>
  </div>

  <!-- Planner Modal (kept IDs) -->
  <div class="modal fade" id="plannerModal" tabindex="-1" aria-labelledby="plannerModalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content rounded-16">
        <div class="modal-header">
          <h5 class="modal-title" id="plannerModalTitle" data-i18n="add_task">Add Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label" for="task-title" data-i18n="title">Title</label>
          <input id="task-title" class="form-control" placeholder="e.g., Read Chapter 3">
          <label class="form-label mt-2" for="task-when" data-i18n="when">When</label>
          <select id="task-when" class="form-select">
            <option value="today" data-i18n="today">Today</option>
            <option value="week" data-i18n="this_week">This Week</option>
            <option value="later" data-i18n="later">Later</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
          <button class="btn btn-primary" id="planner-save" data-i18n="save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="app-toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="app-toast-body">Action completed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Core app JS (unchanged entry order) -->
  <script type="module" src="js/app.js"></script>
  <script type="module" src="js/planner.js"></script>
  <script type="module" src="js/focusTimer.js"></script>
  <script type="module" src="js/dashboard.js"></script>
  <script type="module" src="js/reminders.js"></script>
  <script src="js/sw-register.js" defer></script>

  <!-- i18n (loads after app, so it wins rendering text) -->
  <script src="js/i18n.js" defer></script>
</body>
</html>
