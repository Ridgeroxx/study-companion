<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <title>Reader — Study Companion</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#136FF2">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1324">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' rx='12' fill='%23136FF2'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='38' fill='white'%3ESC%3C/text%3E%3C/svg%3E">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      img-src 'self' data: blob:;
      font-src 'self' data: https://cdnjs.cloudflare.com;
      style-src 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
      style-src-elem 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
      script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
      connect-src 'self' blob:;
      worker-src 'self' blob: https://cdnjs.cloudflare.com;
      object-src 'none';
      base-uri 'self';
      upgrade-insecure-requests;
    ">

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/dark.css">

  <!-- Vendor core -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.92/dist/epub.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if (window['pdfjsLib']) { pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; }</script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    :root{ --topbar-h: 56px; }
    html,body{height:100%}
    body{ margin:0; min-height:100vh; overflow:hidden; background: linear-gradient(180deg, var(--bs-body-bg), var(--bs-body-bg)); }

    .nav-3d{
      position: sticky; top: 0; z-index: 1030;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.62));
      border-bottom: 1px solid rgba(0,0,0,.06); min-height: var(--topbar-h);
    }
    [data-bs-theme="dark"] .nav-3d{ background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05)); border-color: rgba(255,255,255,.14); }
    .brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; font-weight:800; letter-spacing:.2px; }
    .brand img { width:28px; height:28px; border-radius:6px; }

    .reader-toolbar{
      position: sticky; top: var(--topbar-h); z-index: 1020;
      display:flex; gap:.5rem; align-items:center; padding:.5rem;
      border-bottom:1px solid rgba(0,0,0,.06); background: var(--bs-body-bg);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    [data-bs-theme="dark"] .reader-toolbar{ border-color: rgba(255,255,255,.12); }
    .reader-title{ flex:1; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; }

    #page { height: 100vh; display:flex; flex-direction:column; }
    #viewer-wrap{
      flex: 1 1 auto; overflow:auto; -webkit-overflow-scrolling: touch;
      padding: 10px 0 calc(80px + env(safe-area-inset-bottom, 0px)); /* bottom nav clearance */
      background:
        radial-gradient(1200px 700px at -10% -20%, rgba(13,110,253,.06), transparent 60%),
        radial-gradient(800px 600px at 110% 120%, rgba(32,201,151,.08), transparent 60%),
        linear-gradient(180deg, var(--bs-body-bg), var(--bs-body-bg));
    }
    #reader-container{ max-width: 820px; margin: 0 auto; padding: 0 14px; }
    #reader-container :is(p, li){ line-height: 1.7; }
    #reader-container p { margin: 0 0 1rem; }
    #reader-container :is(h1,h2,h3){ font-weight:800; line-height:1.2; margin:1.25rem 0 .6rem; }
    #reader-container blockquote{ border-left: 4px solid rgba(13,110,253,.35); padding: .5rem 1rem; margin: 1rem 0; font-style: italic; background: rgba(13,110,253,.06); }
    [data-bs-theme="dark"] #reader-container blockquote{ background: rgba(255,255,255,.06); border-left-color: rgba(255,255,255,.35); }
    #reader-container code, #reader-container pre{ background: rgba(0,0,0,.06); border-radius: 8px; padding: .1rem .35rem; }
    [data-bs-theme="dark"] #reader-container code, [data-bs-theme="dark"] #reader-container pre{ background: rgba(255,255,255,.08); }
    #reader-container img{ max-width: 100%; height:auto; border-radius: 8px; }

    .pdf-page{ box-shadow:0 2px 10px rgba(0,0,0,.06); background:#fff; margin:0 auto 16px; }
    [data-bs-theme="dark"] .pdf-page{ background:#111 }

    .bottom-nav{
      position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
      display:flex; z-index: 1040; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      background: rgba(255,255,255,.82); border-top: 1px solid rgba(0,0,0,.06);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-bs-theme="dark"] .bottom-nav{ background: rgba(0,0,0,.35); border-top: 1px solid rgba(255,255,255,.12); }
    .bottom-nav a{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; font-size:12px; text-decoration:none; color:inherit; opacity:.85; }
    .bottom-nav a .fa-solid{ font-size:18px; }
    .bottom-nav a.active{ font-weight:700; opacity:1; }
  </style>

  <script>(function(){ document.documentElement.classList.add('js'); })();</script>
</head>
<body>

  <!-- Top bar -->
  <nav class="navbar nav-3d">
    <div class="container-fluid">
      <a class="brand" href="app.html" aria-label="Study Companion" title="Study Companion">
        <img src="logo.png" alt="Logo"><span>Study Companion</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Change language" title="Change language">
            <i class="fa-solid fa-language me-1" aria-hidden="true"></i><span id="current-language">EN</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-label="Language menu">
            <li><button id="lang-en" class="dropdown-item" title="Switch to English">English</button></li>
            <li><button id="lang-es" class="dropdown-item" title="Cambiar a Español">Español</button></li>
          </ul>
        </div>
        <button class="btn btn-sm btn-outline-secondary" id="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
          <i class="fa-solid fa-moon" aria-hidden="true"></i><span class="visually-hidden">Toggle theme</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Reader toolbar -->
  <div class="reader-toolbar">
    <a href="app.html" class="btn btn-sm btn-outline-secondary" id="btn-back" aria-label="Back to Home" title="Back">
      <i class="fa-solid fa-arrow-left" aria-hidden="true"></i><span class="visually-hidden">Back</span>
    </a>

    <div class="btn-group" role="group" aria-label="Reader tools">
      <button class="btn btn-sm btn-outline-secondary" id="btn-toc" aria-label="Toggle table of contents" title="Table of contents">
        <i class="fa-solid fa-list" aria-hidden="true"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="btn-search" aria-label="Search in document" title="Search">
        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="btn-font-dec" aria-label="Decrease font size" title="Font −">
        <i class="fa-solid fa-font" aria-hidden="true"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="btn-font-inc" aria-label="Increase font size" title="Font +">
        <i class="fa-solid fa-font" style="transform: scale(1.15);" aria-hidden="true"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="btn-zoom-dec" aria-label="Zoom out (PDF)" title="Zoom −">
        <i class="fa-solid fa-magnifying-glass-minus" aria-hidden="true"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="btn-zoom-inc" aria-label="Zoom in (PDF)" title="Zoom +">
        <i class="fa-solid fa-magnifying-glass-plus" aria-hidden="true"></i>
      </button>
    </div>

    <div class="reader-title" id="doc-title" title="Document title">Loading…</div>

    <div class="btn-group">
      <button class="btn btn-sm btn-outline-secondary" id="btn-notes" title="Notes"><i class="fa-regular fa-note-sticky"></i></button>
      <button class="btn btn-sm btn-outline-primary" id="export-annotations" aria-label="Export annotations" title="Export annotations">
        <i class="fa-solid fa-download" aria-hidden="true"></i>
      </button>
    </div>
  </div>

  <!-- Page -->
  <div id="page">
    <main id="viewer-wrap">
      <div id="reader-container"></div>
    </main>
  </div>

  <!-- Notes Drawer -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="notesDrawer" aria-labelledby="notesDrawerTitle">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="notesDrawerTitle"><i class="fa-regular fa-note-sticky me-2"></i>Book Notes</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <div class="mb-2 d-flex justify-content-between">
        <strong class="small">Notes & Highlights</strong>
        <button class="btn btn-sm btn-outline-secondary" id="note-new"><i class="fa-solid fa-plus"></i> New</button>
      </div>
      <div id="notes-list" class="small text-muted mb-3">Loading…</div>

      <input type="hidden" id="note-id"/>
      <label class="form-label small" for="note-text">Edit note</label>
      <textarea id="note-text" class="form-control" rows="4" placeholder="Type a note…"></textarea>
      <div class="d-flex justify-content-between gap-2 mt-2">
        <button class="btn btn-sm btn-outline-danger" id="note-del"><i class="fa-regular fa-trash-can"></i></button>
        <button class="btn btn-sm btn-primary" id="note-save"><i class="fa-solid fa-save me-1"></i>Save</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Primary">
    <a href="app.html" data-page="home" title="Home"><i class="fa-solid fa-house"></i><span>Home</span></a>
    <a href="library.html" data-page="library" title="Library"><i class="fa-solid fa-book"></i><span>Library</span></a>
    <a href="notes.html" data-page="notes" title="Notes"><i class="fa-solid fa-note-sticky"></i><span>Notes</span></a>
    <a href="meetings.html" data-page="meetings" title="Meetings"><i class="fa-solid fa-calendar"></i><span>Meetings</span></a>
    <a href="reader.html" data-page="reader" title="Reader"><i class="fa-solid fa-grip"></i><span>Reader</span></a>
    <a href="settings.html" data-page="settings" title="Settings"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
  </nav>

  <!-- Toast -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="app-toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="app-toast-body">Action completed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- App bootstrap -->
  <script type="module" src="js/app.js"></script>

  <script type="module" src="sw-register.js"></script>
  <script type="module" src="sw.js"></script>

  <!-- Reader page logic -->
  <script type="module">
    import { reader } from './js/reader.js';
    import { storage } from './js/storage.js';
    import { exportBookAnnotations } from './js/notes/exporters.js';

    const toast = (msg, type='primary')=>{
      const el = document.getElementById('app-toast'); const body = document.getElementById('app-toast-body');
      if (!el || !body || !window.bootstrap) { console.log(msg); return; }
      body.textContent = msg;
      el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, {autohide:true, delay:1600}).show();
    };
    const esc = s => (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

    const THEME_KEY='app_theme', LANG_KEY='app_lang';

    (async ()=>{
      try {
        const initTheme = localStorage.getItem(THEME_KEY) || 'light';
        document.documentElement.setAttribute('data-bs-theme', initTheme);
        document.getElementById('current-language').textContent =
          (localStorage.getItem(LANG_KEY) || 'EN').toUpperCase();
      } catch {}

      document.querySelectorAll('.bottom-nav a').forEach(a => { if (a.dataset.page==='reader') a.classList.add('active'); });
      document.getElementById('lang-en')?.addEventListener('click', ()=>{ try{localStorage.setItem(LANG_KEY,'EN')}catch{}; const el=document.getElementById('current-language'); if(el) el.textContent='EN'; });
      document.getElementById('lang-es')?.addEventListener('click', ()=>{ try{localStorage.setItem(LANG_KEY,'ES')}catch{}; const el=document.getElementById('current-language'); if(el) el.textContent='ES'; });
      document.getElementById('theme-toggle')?.addEventListener('click', ()=>{
        const curr=document.documentElement.getAttribute('data-bs-theme')||'light';
        const next=curr==='light'?'dark':'light';
        document.documentElement.setAttribute('data-bs-theme', next);
        try{localStorage.setItem(THEME_KEY,next)}catch{}
      });

      try { await storage.init?.(); } catch {}
      const params = new URLSearchParams(location.search);
      const docId = params.get('doc');
      if (!docId) { location.replace('app.html'); return; }

      await reader.init();
      await reader.openDocument(docId, '#reader-container');

      // Title
      try {
        const meta = await storage.getDocument?.(docId);
        document.getElementById('doc-title').textContent = meta?.title || meta?.name || 'Document';
      } catch {}

      // Toolbar actions (guard)
      const call = (fn, ...args)=>{ try { if (typeof fn === 'function') return fn(...args); } catch(e){ console.warn(e); } toast('Not available for this format','secondary'); };
      document.getElementById('btn-toc')?.addEventListener('click', ()=> call(reader.toggleToc));
      document.getElementById('btn-search')?.addEventListener('click', ()=> call(reader.openSearch));
      document.getElementById('btn-font-inc')?.addEventListener('click', ()=>{ reader.setFontScale ? call(reader.setFontScale, (reader._fontScale=(reader._fontScale||1)+0.1)) : (document.getElementById('reader-container').style.fontSize=((reader._fontScale=(reader._fontScale||1)+0.1)*100)+'%'); });
      document.getElementById('btn-font-dec')?.addEventListener('click', ()=>{ reader.setFontScale ? call(reader.setFontScale, (reader._fontScale=Math.max(0.8,(reader._fontScale||1)-0.1))) : (document.getElementById('reader-container').style.fontSize=((reader._fontScale=Math.max(0.8,(reader._fontScale||1)-0.1))*100)+'%'); });
      document.getElementById('btn-zoom-inc')?.addEventListener('click', ()=> call(reader.zoomIn));
      document.getElementById('btn-zoom-dec')?.addEventListener('click', ()=> call(reader.zoomOut));

      // Export
      document.getElementById('export-annotations')?.addEventListener('click', async ()=>{
        try {
          const doc  = await storage.getDocument?.(docId);
          const anns = await (storage.getAnnotations?.(docId) || []);
          if (!anns.length) { toast('No annotations found for this document.','secondary'); return; }
          const choice = (prompt('Export format? md / html / pdf','pdf')||'').trim().toLowerCase();
          const fmt = ['md','html','pdf'].includes(choice) ? choice : 'pdf';
          exportBookAnnotations({ docMeta:{ title: doc?.title||'Untitled', author: doc?.author||'' }, annotations: anns }, fmt);
        } catch (e) { console.error(e); toast('Export failed','danger'); }
      });

      // Notes Drawer

const notesDrawer = new bootstrap.Offcanvas(document.getElementById('notesDrawer'));
const noteIdEl = document.getElementById('note-id');
const noteText = document.getElementById('note-text');
const listEl   = document.getElementById('notes-list');

function setEditor(id='', text=''){ noteIdEl.value = id||''; noteText.value = text||''; }

async function renderNotes(){
  const list = await storage.getAnnotations(docId) || [];
  if (!list.length){ listEl.innerHTML = `<div class="text-muted">No notes yet.</div>`; return; }
  listEl.innerHTML = list.map(it=>`
    <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-start">
      <div class="me-2 small">${(it.text || it.quote || '').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}</div>
      <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-primary" data-edit="${it.id}"><i class="fa-regular fa-pen-to-square"></i></button>
        <button class="btn btn-outline-danger"  data-del="${it.id}"><i class="fa-regular fa-trash-can"></i></button>
      </div>
    </div>
  `).join('');

  // bind edit/delete (as you already have)
  listEl.querySelectorAll('[data-edit]').forEach(b => b.onclick = ()=>{
    const id=b.getAttribute('data-edit'); const it=(list||[]).find(x=>x.id===id);
    if (!it) return; setEditor(it.id, it.text || it.quote || '');
  });
  listEl.querySelectorAll('[data-del]').forEach(b => b.onclick = async ()=>{
    const id=b.getAttribute('data-del'); if (!id) return;
    if (!confirm('Delete this note?')) return;
    const next = (list||[]).filter(x=>x.id!==id);
    await storage.saveAnnotations(docId, next);
    setEditor('',''); await renderNotes();
    toast('Deleted','danger');
  });

  return list;
}

// 🔧 Deep-link handler: open drawer at a specific note
window.addEventListener('reader:openNote', async (ev)=>{
  const targetId = ev.detail?.noteId;
  const list = await renderNotes();
  if (targetId) {
    const it = (list||[]).find(n=>n.id===targetId);
    if (it) setEditor(it.id, it.text || it.quote || '');
  }
  notesDrawer.show();
});

// Also check URL on load (in case the event didn’t fire)
const urlNote = new URLSearchParams(location.search).get('note');
if (urlNote) {
  const list = await renderNotes();
  const it = (list||[]).find(n=>n.id===urlNote);
  if (it) setEditor(it.id, it.text || it.quote || '');
  notesDrawer.show();
}

      document.getElementById('btn-notes')?.addEventListener('click', async ()=>{
        await renderNotes(); notesDrawer.show();
      });
      document.getElementById('note-new')?.addEventListener('click', ()=> setEditor('',''));
      document.getElementById('note-save')?.addEventListener('click', async ()=>{
        const id   = (noteIdEl.value||'').trim();
        const text = (noteText.value||'').trim();
        if (!text) { toast('Nothing to save','secondary'); return; }
        const now = new Date().toISOString();
        const list = await storage.getAnnotations(docId) || [];
        if (id){
          const i = list.findIndex(a=>a.id===id);
          if (i>=0) list[i] = { ...list[i], text, updatedAt: now, kind: list[i].kind || 'note', documentId: docId };
        } else {
          const newAnn = {
            id: (storage.generateId ? storage.generateId('ann') : ('ann_'+Date.now())),
            documentId: docId, kind: 'note', text, createdAt: now, updatedAt: now
          };
          list.push(newAnn);
        }
        await storage.saveAnnotations(docId, list);
        await renderNotes(); toast('Saved','success');
      });
      document.getElementById('note-del')?.addEventListener('click', async ()=>{
        const id = (noteIdEl.value||'').trim(); if (!id) { toast('Nothing selected','secondary'); return; }
        if (!confirm('Delete this note?')) return;
        const list = await storage.getAnnotations(docId) || [];
        await storage.saveAnnotations(docId, list.filter(x=>x.id!==id));
        setEditor('',''); await renderNotes(); toast('Deleted','danger');
      });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
