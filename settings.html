<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings — Study Companion</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#136FF2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="logo.png">

  <meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    img-src 'self' data: blob:;
    font-src 'self' data: https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    style-src-elem 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
    connect-src 'self' blob:;
    worker-src 'self' blob: https://cdnjs.cloudflare.com;
    object-src 'none';
    base-uri 'self';
    upgrade-insecure-requests;
  ">

  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/dark.css">

  <style>
    .set-card{ border:1px solid #e9ecef; border-radius:12px; background:var(--bs-body-bg); }
  </style>
</head>
<body>
  <nav class="navbar bg-light border-bottom sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="app.html" title="Back">
          <i class="fa-solid fa-arrow-left"></i>
        </a>
        <span class="fw-semibold">Settings</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="lang-en">EN</button>
        <button class="btn btn-sm btn-outline-secondary" id="lang-es">ES</button>
        <button class="btn btn-sm btn-outline-secondary" id="theme-toggle" title="Theme">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <!-- App -->
    <div class="set-card p-3 mb-3">
      <h5 class="mb-3"><i class="fa-solid fa-gear me-2"></i>App</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Language</label>
          <select id="settings-language" class="form-select">
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Theme</label>
          <select id="settings-theme" class="form-select">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="col-12">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="settings-pwa" />
            <label class="form-check-label" for="settings-pwa">Enable offline mode (PWA)</label>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" id="btn-save-settings"><i class="fa-solid fa-floppy-disk me-1"></i> Save Settings</button>
      </div>
    </div>

    <!-- Security -->
    <!-- Security -->
<div class="set-card p-3 mb-3">
  <h5 class="mb-2"><i class="fa-solid fa-lock me-2"></i>Security</h5>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <h6 class="mb-2">App Lock</h6>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">New PIN</label>
          <input id="sec-pin1" type="password" inputmode="numeric" class="form-control" placeholder="1234">
        </div>
        <div class="col-6">
          <label class="form-label">Confirm PIN</label>
          <input id="sec-pin2" type="password" inputmode="numeric" class="form-control" placeholder="1234">
        </div>
        <div class="col-6">
          <label class="form-label">Idle Lock (minutes)</label>
          <input id="sec-idle" type="number" min="1" class="form-control" value="15">
        </div>
        <div class="col-6 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sec-bio">
            <label class="form-check-label" for="sec-bio">Allow biometric (WebAuthn)</label>
          </div>
        </div>
      </div>
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-primary" id="sec-enable"><i class="fa-solid fa-unlock-keyhole me-1"></i>Enable Lock</button>
        <button class="btn btn-outline-danger" id="sec-disable"><i class="fa-solid fa-ban me-1"></i>Disable Lock</button>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <h6 class="mb-2">Encryption at Rest</h6>
      <div class="row g-2">
        <div class="col-12">
          <label class="form-label">Passphrase</label>
          <input id="enc-pass" type="password" class="form-control" placeholder="********">
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="enc-remember">
            <label class="form-check-label" for="enc-remember">Remember this session</label>
          </div>
        </div>
      </div>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <button class="btn btn-primary" id="enc-enable"><i class="fa-solid fa-shield-halved me-1"></i>Enable Encryption</button>
        <button class="btn btn-outline-secondary" id="enc-resume"><i class="fa-solid fa-key me-1"></i>Unlock Session</button>
        <button class="btn btn-outline-danger" id="enc-disable"><i class="fa-solid fa-xmark me-1"></i>Disable</button>
      </div>
      <div class="form-text mt-1">Encrypted data uses AES-GCM; passphrase is not stored.</div>
    </div>
  </div>
</div>

<!-- Sync -->
<div class="set-card p-3 mb-3">
  <h5 class="mb-2"><i class="fa-solid fa-arrows-rotate me-2"></i>Sync (Manual · WebDAV)</h5>
  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label">Endpoint (base URL)</label>
      <input id="dav-endpoint" class="form-control" placeholder="https://example.com/dav/">
    </div>
    <div class="col-md-3">
      <label class="form-label">Username</label>
      <input id="dav-user" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Password</label>
      <input id="dav-pass" type="password" class="form-control">
    </div>
    <div class="col-12">
      <label class="form-label">Remote Path</label>
      <input id="dav-path" class="form-control" placeholder="/StudyCompanion/bundle.json">
    </div>
  </div>
  <div class="mt-2 d-flex flex-wrap gap-2">
    <button class="btn btn-outline-secondary" id="dav-save"><i class="fa-solid fa-floppy-disk me-1"></i>Save</button>
    <button class="btn btn-outline-secondary" id="dav-check"><i class="fa-solid fa-list-check me-1"></i>Check Remote</button>
    <button class="btn btn-outline-primary" id="dav-download"><i class="fa-solid fa-download me-1"></i>Download</button>
    <button class="btn btn-primary" id="dav-upload"><i class="fa-solid fa-upload me-1"></i>Upload</button>
  </div>
  <div class="form-text mt-1">Sync pushes/pulls your JSON bundle on demand. Offline use is never blocked.</div>
</div>

  </main>

  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="app-toast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="app-toast-body">Saved.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module" src="js/app.js"></script>
  <script type="module">
    import { storage } from './js/storage.js';
    import { schedule } from './js/schedule.js'; // if you use it elsewhere
    import { FLAGS } from './js/flags.js';
    import { setupPIN } from './js/security/lock.js';
    import { makeBundle } from './js/sync/bundle.js';
    import { connect, uploadBundle, downloadBundle } from './js/sync/webdav.js';
    import { enableEncryption, disableEncryption, isPatched } from './js/security/patch-localforage.js';
    import { lock } from './js/security/lock.js';
    import * as cryptoStore from './js/security/cryptoStore.js';
    import * as webdav from './js/sync/webdav.js';


    const $ = (s, r=document) => r.querySelector(s);
    const toast = (msg, type='primary') => {
      const el = $('#app-toast'), body = $('#app-toast-body');
      body.textContent = msg; el.className = `toast align-items-center text-bg-${type} border-0 shadow`;
      new bootstrap.Toast(el, {autohide:true, delay:1600}).show();
    };

    const langSel = $('#settings-language');
    const themeSel = $('#settings-theme');
    const pwaChk  = $('#settings-pwa');

    const pinNew  = $('#pin-new');
    const pinIdle = $('#pin-idle');
    const encChk  = $('#enable-encryption');
    const encWrap = $('#enc-wrap');
    const encPass = $('#enc-pass');

    const davUrl  = $('#dav-url'); const davUser = $('#dav-user'); const davPass = $('#dav-pass');
    const syncStatus = $('#sync-status');

    async function loadSettingsIntoForm(){
      await storage.init?.();
      const s = await (storage.getSettings?.() || {});
      langSel.value  = s.lang || (localStorage.getItem('app_lang') || 'en');
      themeSel.value = s.theme || (localStorage.getItem('app_theme') || 'light');
      pwaChk.checked = !!s.pwaEnabled;
      // idle seconds if saved
      const lockCfg = await localforage.getItem('lock_settings');
      pinIdle.value = (lockCfg?.idleSec || 180);
      // encryption visible
      encWrap.style.display = encChk.checked ? 'block' : 'none';
    }

    async function saveSettings(){
      const curr = await (storage.getSettings?.() || {});
      const s = {
        ...curr,
        lang:  langSel.value || 'en',
        theme: themeSel.value || 'light',
        pwaEnabled: !!pwaChk.checked
      };
      await storage.saveSettings?.(s);
      document.documentElement.setAttribute('data-bs-theme', s.theme);
      try { localStorage.setItem('app_theme', s.theme); localStorage.setItem('app_lang', s.lang); } catch {}
      toast('Settings saved','success');
    }

    // PIN setup
    $('#btn-set-pin').onclick = async ()=>{
      const pin = (pinNew.value||'').trim();
      if (!pin) { alert('Enter a PIN'); return; }
      await setupPIN(pin);
      // store idleSec
      const L = await localforage.getItem('lock_settings');
      L.idleSec = Math.max(30, Number(pinIdle.value||180));
      await localforage.setItem('lock_settings', L);
      toast('PIN set','success'); pinNew.value='';
    };

    encChk.addEventListener('change', ()=> encWrap.style.display = encChk.checked ? 'block' : 'none');
    $('#btn-enable-enc').onclick = async ()=>{
      if (!FLAGS.encryption){ alert('Enable encryption flag in /js/flags.js first.'); return; }
      const pass = encPass.value || '';
      if (!pass) { alert('Enter a passphrase'); return; }
      const saltHex = await enableEncryption(pass);
      const s = await (storage.getSettings?.() || {}); s.new = s.new || {}; s.new.security = s.new.security || {};
      s.new.security.encrypted = true; s.new.security.saltHex = saltHex;
      await storage.saveSettings?.(s);
      toast('Encryption enabled. Reload recommended.','success');
    };
    $('#btn-disable-enc').onclick = async ()=>{
      disableEncryption();
      const s = await (storage.getSettings?.() || {}); s.new = s.new || {}; s.new.security = s.new.security || {};
      s.new.security.encrypted = false;
      await storage.saveSettings?.(s);
      toast('Encryption disabled','secondary');
    };

    // Sync
    $('#btn-push').onclick = async ()=>{
      try{
        if (!FLAGS.sync){ alert('Enable sync flag in /js/flags.js first.'); return; }
        const conn = connect({ url: davUrl.value, username: davUser.value, password: davPass.value });
        const bundle = await makeBundle(storage);
        await uploadBundle(conn, bundle);
        syncStatus.textContent = 'Pushed successfully at ' + new Date().toLocaleTimeString();
        toast('Pushed','success');
      }catch(e){ console.error(e); toast('Push failed','danger'); }
    };
    $('#btn-pull').onclick = async ()=>{
      try{
        if (!FLAGS.sync){ alert('Enable sync flag in /js/flags.js first.'); return; }
        const conn = connect({ url: davUrl.value, username: davUser.value, password: davPass.value });
        const remote = await downloadBundle(conn);
        // Simple preview
        syncStatus.innerHTML = `
          <div>Remote version: ${remote.version}</div>
          <div>Docs: ${remote.library?.docs?.length||0}, Annotations: ${remote.notes?.annotations?.length||0}</div>
          <button class="btn btn-sm btn-primary mt-1" id="btn-apply-pull">Apply</button>`;
        document.getElementById('btn-apply-pull').onclick = async ()=>{
          // naive apply: overwrite (you can implement a 2-way merge)
          await storage.setDocuments?.(remote.library?.docs || []);
          await storage.setFavorites?.(remote.library?.favorites || []);
          await storage.saveAllAnnotations?.(remote.notes?.annotations || []);
          await storage.saveMeetingNotes?.(remote.notes?.meeting || []);
          await storage.saveSchedule?.('midweek', remote.meetings?.schedules?.midweek || {});
          await storage.saveSchedule?.('weekend', remote.meetings?.schedules?.weekend || {});
          await storage.saveSettings?.(remote.settings || {});
          toast('Pulled','success');
        };
      }catch(e){ console.error(e); toast('Pull failed','danger'); }
    };

    $('#btn-save-settings').onclick = saveSettings;

    (async ()=>{
      try { await storage.init?.(); } catch {}
      try { await schedule.init?.(); } catch {}
      await loadSettingsIntoForm();
    })();
    // ---- Security: App Lock
document.getElementById('sec-enable')?.addEventListener('click', async ()=>{
  const p1 = document.getElementById('sec-pin1').value.trim();
  const p2 = document.getElementById('sec-pin2').value.trim();
  const idle = Math.max(1, parseInt(document.getElementById('sec-idle').value||'15',10));
  const bio = !!document.getElementById('sec-bio').checked;
  if (!p1 || p1 !== p2) { toast('PIN mismatch','danger'); return; }
  await lock.setupPin(p1, bio, idle);
  toast('App Lock enabled','success');
});

document.getElementById('sec-disable')?.addEventListener('click', async ()=>{
  await lock.disable();
  toast('App Lock disabled','secondary');
});

// ---- Security: Encryption
document.getElementById('enc-enable')?.addEventListener('click', async ()=>{
  const pass = document.getElementById('enc-pass').value;
  const remember = !!document.getElementById('enc-remember').checked;
  if (!pass) { toast('Enter passphrase','danger'); return; }
  await cryptoStore.enable(pass, remember);
  window.FEATURE_ENCRYPTION = true;
  toast('Encryption enabled','success');
});

document.getElementById('enc-resume')?.addEventListener('click', async ()=>{
  const pass = document.getElementById('enc-pass').value;
  if (!pass) { toast('Enter passphrase','danger'); return; }
  const ok = await cryptoStore.resume(pass);
  if (!ok) { toast('No encrypted data or wrong passphrase','danger'); return; }
  window.FEATURE_ENCRYPTION = true;
  toast('Session unlocked','success');
});

document.getElementById('enc-disable')?.addEventListener('click', async ()=>{
  await cryptoStore.disable();
  window.FEATURE_ENCRYPTION = false;
  toast('Encryption disabled','secondary');
});

// ---- Sync: WebDAV
async function loadDavForm(){
  const cfg = await webdav.loadConfig() || {};
  document.getElementById('dav-endpoint').value = cfg.endpoint || '';
  document.getElementById('dav-user').value = cfg.username || '';
  document.getElementById('dav-pass').value = cfg.password || '';
  document.getElementById('dav-path').value = cfg.remotePath || '/StudyCompanion/bundle.json';
}
document.getElementById('dav-save')?.addEventListener('click', async ()=>{
  const cfg = {
    endpoint: document.getElementById('dav-endpoint').value.trim(),
    username: document.getElementById('dav-user').value.trim(),
    password: document.getElementById('dav-pass').value,
    remotePath: document.getElementById('dav-path').value.trim() || '/StudyCompanion/bundle.json'
  };
  await webdav.saveConfig(cfg);
  toast('Sync settings saved','success');
});
document.getElementById('dav-check')?.addEventListener('click', async ()=>{
  try {
    const r = await webdav.listRemote();
    toast(r.exists ? `Remote exists (ETag ${r.etag||'-'})` : 'Not found','secondary');
  } catch(e){ console.error(e); toast('Check failed','danger'); }
});
document.getElementById('dav-upload')?.addEventListener('click', async ()=>{
  try {
    // You already have an export-bundle helper; if not, quickly build it:
    const bundle = await (storage.exportBundle?.() || { version:'2.0' });
    await webdav.uploadBundle(bundle);
    toast('Uploaded','success');
  } catch(e){ console.error(e); toast('Upload failed','danger'); }
});
document.getElementById('dav-download')?.addEventListener('click', async ()=>{
  try {
    const remote = await webdav.downloadBundle();
    // Preview/diff UI optional — for now just import:
    await (storage.importBundle?.(remote));
    toast('Downloaded & applied','success');
  } catch(e){ console.error(e); toast('Download failed','danger'); }
});

// Kick off lock idle watcher & load current sync cfg
try { await lock.init({ idleMinutes: 15 }); } catch {}
await loadDavForm();

  </script>
</body>
</html>
